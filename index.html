<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Tracker - Evergreen Metal Works</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js">

// Update Firebase status indicator
function updateFirebaseStatus() {
    const statusEl = document.getElementById('firebaseStatus');
    const dotEl = statusEl ? statusEl.querySelector('.status-dot') : null;
    const textEl = document.getElementById('statusText');
    
    if (!statusEl || !dotEl || !textEl) return;
    
    if (firebaseActive) {
        statusEl.className = 'firebase-status active';
        dotEl.className = 'status-dot active';
        textEl.textContent = 'Cloud Sync';
    } else {
        statusEl.className = 'firebase-status inactive';
        dotEl.className = 'status-dot inactive';
        textEl.textContent = 'Local';
    }
}

// Call this after Firebase init
setTimeout(updateFirebaseStatus, 1000);

</script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js">

// Update Firebase status indicator
function updateFirebaseStatus() {
    const statusEl = document.getElementById('firebaseStatus');
    const dotEl = statusEl ? statusEl.querySelector('.status-dot') : null;
    const textEl = document.getElementById('statusText');
    
    if (!statusEl || !dotEl || !textEl) return;
    
    if (firebaseActive) {
        statusEl.className = 'firebase-status active';
        dotEl.className = 'status-dot active';
        textEl.textContent = 'Cloud Sync';
    } else {
        statusEl.className = 'firebase-status inactive';
        dotEl.className = 'status-dot inactive';
        textEl.textContent = 'Local';
    }
}

// Call this after Firebase init
setTimeout(updateFirebaseStatus, 1000);

</script>

    <!-- Firebase SDK - OPTIONAL (works without config) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js">

// Update Firebase status indicator
function updateFirebaseStatus() {
    const statusEl = document.getElementById('firebaseStatus');
    const dotEl = statusEl ? statusEl.querySelector('.status-dot') : null;
    const textEl = document.getElementById('statusText');
    
    if (!statusEl || !dotEl || !textEl) return;
    
    if (firebaseActive) {
        statusEl.className = 'firebase-status active';
        dotEl.className = 'status-dot active';
        textEl.textContent = 'Cloud Sync';
    } else {
        statusEl.className = 'firebase-status inactive';
        dotEl.className = 'status-dot inactive';
        textEl.textContent = 'Local';
    }
}

// Call this after Firebase init
setTimeout(updateFirebaseStatus, 1000);

</script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js">

// Update Firebase status indicator
function updateFirebaseStatus() {
    const statusEl = document.getElementById('firebaseStatus');
    const dotEl = statusEl ? statusEl.querySelector('.status-dot') : null;
    const textEl = document.getElementById('statusText');
    
    if (!statusEl || !dotEl || !textEl) return;
    
    if (firebaseActive) {
        statusEl.className = 'firebase-status active';
        dotEl.className = 'status-dot active';
        textEl.textContent = 'Cloud Sync';
    } else {
        statusEl.className = 'firebase-status inactive';
        dotEl.className = 'status-dot inactive';
        textEl.textContent = 'Local';
    }
}

// Call this after Firebase init
setTimeout(updateFirebaseStatus, 1000);

</script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #2d7a3e 0%, #1a5928 100%); min-height: 100vh; }
        
        /* Login Page Styles */
        #loginPage { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #2d7a3e 0%, #1a5928 100%); z-index: 9999; }
        #loginPage.hidden { display: none; }
        .login-card { background: white; padding: 40px 30px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-width: 420px; width: 100%; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .login-logo { text-align: center; margin-bottom: 30px; }
        .login-logo img { max-width: 280px; width: 100%; height: auto; }
        .login-title { color: #2d7a3e; font-size: 28px; text-align: center; margin-bottom: 8px; font-weight: bold; }
        .login-subtitle { color: #666; font-size: 14px; text-align: center; margin-bottom: 30px; }
        .login-form-group { margin-bottom: 20px; }
        .login-form-group label { display: block; color: #333; font-weight: 600; margin-bottom: 8px; font-size: 14px; }
        .login-form-group input { width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; transition: all 0.3s; }
        .login-form-group input:focus { outline: none; border-color: #2d7a3e; box-shadow: 0 0 0 3px rgba(45,122,62,0.1); }
        .login-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #2d7a3e 0%, #1a5928 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(45,122,62,0.4); }
        .login-btn:active { transform: translateY(0); }
        .login-error { background: #dc3545; color: white; padding: 12px; border-radius: 8px; margin-bottom: 20px; text-align: center; display: none; font-size: 14px; font-weight: 600; }
        .login-error.show { display: block; animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
        
        /* Main App Styles */
        .app-wrapper { display: none; padding: 10px; }
        .app-wrapper.show { display: block; }
        .container { max-width: 600px; margin: 0 auto; }
        .header { background: white; padding: 16px 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
        .header-left { display: flex; align-items: center; gap: 12px; flex: 1; }
        .header-logo img { height: 45px; width: auto; }
        .header-text h1 { color: #2d7a3e; font-size: 19px; margin-bottom: 2px; }
        .header-text p { color: #666; font-size: 11px; }
        .header-right { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .user-badge { background: #e8f5e9; color: #2d7a3e; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; }
        .logout-btn { padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s; }
        .logout-btn:hover { background: #c82333; transform: translateY(-1px); }
        
        .tab-container { display: flex; gap: 6px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; -webkit-overflow-scrolling: touch; }
        .tab-container::-webkit-scrollbar { height: 4px; }
        .tab-container::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.5); border-radius: 2px; }
        .tab { flex: 1; min-width: 75px; padding: 12px 8px; background: rgba(255,255,255,0.3); border: none; border-radius: 10px; color: white; font-weight: bold; font-size: 11px; cursor: pointer; transition: all 0.3s; white-space: nowrap; text-align: center; }
        .tab.active { background: white; color: #2d7a3e; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .tab:hover:not(.active) { background: rgba(255,255,255,0.4); }
        
        .sub-tab-container { display: flex; gap: 10px; margin-bottom: 20px; }
        .sub-tab { flex: 1; padding: 12px; background: #f0f0f0; border: 2px solid #e0e0e0; border-radius: 8px; color: #666; font-weight: 600; cursor: pointer; transition: all 0.3s; text-align: center; }
        .sub-tab.active { background: #2d7a3e; color: white; border-color: #2d7a3e; }
        
        .content { display: none; }
        .content.active { display: block; animation: fadeIn 0.3s; }
        .card { background: white; padding: 20px; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; color: #333; font-weight: 600; margin-bottom: 8px; font-size: 14px; }
        .form-group select, .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; transition: border-color 0.3s; font-family: inherit; }
        .form-group textarea { resize: vertical; min-height: 100px; font-family: monospace; font-size: 13px; }
        .form-group select:focus, .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #2d7a3e; box-shadow: 0 0 0 3px rgba(45,122,62,0.1); }
        
        .info-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px; background: #e8f5e9; border-radius: 8px; margin-bottom: 20px; }
        .info-item { text-align: center; }
        .info-item label { display: block; font-size: 10px; color: #2d7a3e; margin-bottom: 5px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .info-item .value { font-size: 14px; color: #333; font-weight: bold; }
        
        .width-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
        .width-btn { padding: 12px 8px; border: 2px solid #e0e0e0; background: white; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .width-btn.selected { background: #2d7a3e; color: white; border-color: #2d7a3e; transform: scale(1.05); box-shadow: 0 2px 8px rgba(45,122,62,0.3); }
        .width-btn:hover:not(.selected) { border-color: #2d7a3e; background: #f8fef9; }
        
        .submit-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #2d7a3e 0%, #1a5928 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .submit-btn:hover { box-shadow: 0 5px 15px rgba(45,122,62,0.3); transform: translateY(-1px); }
        .submit-btn:active { transform: translateY(0); }
        
        .manage-btn { color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s; }
        .delete-btn { background: #dc3545; }
        .delete-btn:hover { background: #c82333; transform: translateY(-1px); }
        .archive-btn { background: #6c757d; }
        .archive-btn:hover { background: #5a6268; transform: translateY(-1px); }
        .hold-btn { background: #ffc107; color: #000; }
        .hold-btn:hover { background: #e0a800; transform: translateY(-1px); }
        
        .production-list { max-height: 400px; overflow-y: auto; }
        .production-item { padding: 14px; border-left: 4px solid #2d7a3e; background: #f8f9fa; margin-bottom: 10px; border-radius: 6px; transition: all 0.2s; }
        .production-item:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .production-item h3 { color: #333; font-size: 15px; margin-bottom: 6px; }
        .production-item p { color: #666; font-size: 12px; margin-bottom: 4px; line-height: 1.5; }
        .production-item .time { color: #2d7a3e; font-weight: 600; }
        .production-item .remark { background: #fff3cd; padding: 8px; border-radius: 5px; margin-top: 8px; font-style: italic; color: #856404; font-size: 12px; }
        
        .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .progress-header h3 { color: #333; font-size: 18px; }
        .progress-percent { font-size: 26px; font-weight: bold; color: #2d7a3e; }
        
        .progress-bar-container { width: 100%; height: 32px; background: #e0e0e0; border-radius: 16px; overflow: hidden; margin-bottom: 20px; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #2d7a3e 0%, #1a5928 100%); transition: width 0.6s ease; display: flex; align-items: center; justify-content: flex-end; padding-right: 12px; }
        .progress-bar span { color: white; font-weight: bold; font-size: 13px; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
        .stat-box { background: linear-gradient(135deg, #2d7a3e 0%, #1a5928 100%); padding: 18px; border-radius: 12px; text-align: center; color: white; }
        .stat-box h4 { font-size: 12px; opacity: 0.9; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-box p { font-size: 26px; font-weight: bold; }
        
        .group-progress { margin-bottom: 18px; }
        .group-header { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .group-header span { color: #666; font-size: 13px; font-weight: 600; }
        .group-bar { height: 22px; background: #e0e0e0; border-radius: 11px; overflow: hidden; }
        .group-fill { height: 100%; background: #2d7a3e; transition: width 0.6s ease; }
        
        .production-table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 12px; }
        .production-table th { background: #2d7a3e; color: white; padding: 10px 8px; text-align: left; font-weight: 600; font-size: 11px; text-transform: uppercase; }
        .production-table td { padding: 10px 8px; border-bottom: 1px solid #e0e0e0; }
        .production-table tr.completed { background: #d4edda; }
        .production-table tr.pending { background: #f8d7da; }
        .production-table tr:hover { background: #f8f9fa; }
        
        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .status-completed { background: #28a745; color: white; }
        .status-pending { background: #dc3545; color: white; }
        
        .table-section { margin-bottom: 25px; }
        .table-section h4 { color: #2d7a3e; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 2px solid #2d7a3e; font-size: 14px; }
        
        .timestamp { font-size: 11px; color: #999; text-align: center; margin-top: 10px; }
        
        .success-msg { background: #28a745; color: white; padding: 14px; border-radius: 10px; margin-bottom: 15px; text-align: center; display: none; font-size: 14px; font-weight: 600; }
        .success-msg.show { display: block; animation: slideIn 0.3s ease; }
        
        .error-msg { background: #dc3545; color: white; padding: 14px; border-radius: 10px; margin-bottom: 15px; text-align: center; display: none; font-size: 14px; font-weight: 600; }
        .error-msg.show { display: block; animation: slideIn 0.3s ease; }
        
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .month-selector { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .month-selector select { flex: 1; min-width: 120px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
        .export-btn { padding: 10px 20px; background: #2d7a3e; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px; transition: all 0.2s; white-space: nowrap; }
        .export-btn:hover { background: #1a5928; transform: translateY(-1px); }
        
        .report-summary { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
        .summary-box { background: #e8f5e9; padding: 14px; border-radius: 10px; border-left: 4px solid #2d7a3e; }
        .summary-box h4 { color: #2d7a3e; font-size: 11px; margin-bottom: 5px; text-transform: uppercase; font-weight: 600; }
        .summary-box p { color: #333; font-size: 22px; font-weight: bold; }
        
        .chart-container { position: relative; height: 280px; margin-bottom: 20px; }
        
        .job-card-list { margin-top: 15px; }
        .job-card-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #2d7a3e; flex-wrap: wrap; gap: 10px; }
        .job-card-info { flex: 1; min-width: 200px; }
        .job-card-info h4 { color: #333; font-size: 14px; margin-bottom: 4px; }
        .job-card-info p { color: #666; font-size: 11px; }
        
        .archive-badge { background: #ffc107; color: #000; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-left: 8px; }
        .hold-badge { background: #ff9800; color: white; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-left: 8px; }
        
        /* Customer Section Styles */
        .customer-card { background: white; padding: 16px; border-radius: 12px; margin-bottom: 14px; border-left: 4px solid #2d7a3e; cursor: pointer; transition: all 0.3s; }
        .customer-card:hover { box-shadow: 0 6px 16px rgba(0,0,0,0.12); transform: translateY(-2px); }
        .customer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .customer-name { color: #2d7a3e; font-size: 18px; font-weight: bold; }
        .customer-icon { font-size: 20px; color: #2d7a3e; transition: transform 0.3s; }
        .customer-card.expanded .customer-icon { transform: rotate(180deg); }
        .customer-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 10px; }
        .customer-stat { text-align: center; padding: 8px; background: #f8f9fa; border-radius: 6px; }
        .customer-stat-value { font-size: 18px; font-weight: bold; color: #2d7a3e; }
        .customer-stat-label { font-size: 10px; color: #666; text-transform: uppercase; margin-top: 2px; }
        
        .customer-orders { margin-top: 15px; display: none; border-top: 2px dashed #e0e0e0; padding-top: 12px; }
        .customer-orders.show { display: block; animation: fadeIn 0.3s; }
        
        .order-item { background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid #6c757d; transition: all 0.2s; }
        .order-item:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; flex-wrap: wrap; gap: 8px; }
        .order-number { font-weight: bold; color: #333; font-size: 13px; }
        .order-type { background: #17a2b8; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; }
        .order-progress { font-size: 12px; color: #666; margin: 6px 0; }
        .order-progress-bar { height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden; margin-top: 4px; }
        .order-progress-fill { height: 100%; background: linear-gradient(90deg, #28a745 0%, #20c997 100%); transition: width 0.3s; }
        .order-progress-fill.complete { background: #28a745; }
        .order-details-btn { padding: 6px 12px; background: #2d7a3e; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 11px; font-weight: 600; transition: all 0.2s; }
        .order-details-btn:hover { background: #1a5928; transform: translateY(-1px); }
        
        .order-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .order-modal.show { display: flex; animation: fadeIn 0.2s; }
        .order-modal-content { background: white; padding: 25px; border-radius: 15px; max-width: 540px; width: 100%; max-height: 85vh; overflow-y: auto; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .modal-close { position: absolute; right: 20px; top: 15px; font-size: 28px; font-weight: bold; cursor: pointer; color: #999; transition: color 0.2s; }
        .modal-close:hover { color: #333; }
        .modal-title { color: #2d7a3e; font-size: 20px; font-weight: bold; margin-bottom: 20px; padding-right: 30px; }
        .modal-info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
        .modal-info-item { }
        .modal-info-label { font-size: 10px; color: #666; text-transform: uppercase; margin-bottom: 3px; font-weight: 600; }
        .modal-info-value { font-size: 13px; color: #333; font-weight: 600; }
        .modal-divider { height: 2px; background: linear-gradient(to right, #2d7a3e, transparent); margin: 20px 0; }
        .modal-section { margin-bottom: 18px; }
        .modal-section-title { color: #2d7a3e; font-size: 14px; font-weight: bold; margin-bottom: 10px; border-bottom: 2px solid #e8f5e9; padding-bottom: 5px; }
        .modal-width-item { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f0f0f0; font-size: 12px; }
        .modal-width-name { color: #666; }
        .modal-width-status { font-weight: 600; }
        .modal-width-status.complete { color: #28a745; }
        .modal-width-status.pending { color: #dc3545; }
        .modal-overall { background: #e8f5e9; padding: 15px; border-radius: 8px; margin-top: 20px; }
        .modal-overall-title { color: #2d7a3e; font-size: 12px; text-transform: uppercase; margin-bottom: 8px; font-weight: 600; }
        .modal-overall-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .modal-overall-stat { text-align: center; }
        .modal-overall-value { font-size: px; font-weight: bold; color: #2d7a3e; }
        .modal-overall-label { font-size: 10px; color: #666; margin-top: 2px; }
        
        @media (max-width: 600px) {
            .header { flex-direction: column; text-align: center; padding: 12px; }
            .header-left { flex-direction: column; gap: 8px; }
            .header-right { width: 100%; justify-content: center; }
            .tab { font-size: 10px; padding: 10px 6px; min-width: 65px; }
            .customer-stats { grid-template-columns: repeat(3, 1fr); gap: 8px; }
            .modal-info-grid { grid-template-columns: 1fr; }
            .modal-overall-stats { grid-template-columns: 1fr; }
            .order-header { flex-direction: column; align-items: flex-start; }
        }

        .edit-btn { background: #17a2b8; }
        .edit-btn:hover { background: #138496; transform: translateY(-1px); }
        .data-btn { padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; margin-left: 8px; }
        .data-btn:hover { background: #218838; }
        .data-btn.import { background: #17a2b8; }
        .data-btn.import:hover { background: #138496; }
        .edit-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1001; align-items: center; justify-content: center; padding: 20px; }
        .edit-modal.show { display: flex; }
        .edit-modal-content { background: white; padding: 25px; border-radius: 15px; max-width: 500px; width: 100%; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }

        /* Firebase Status Indicator */
        .firebase-status { position: fixed; bottom: 20px; right: 20px; background: white; padding: 6px 12px; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); font-size: 10px; font-weight: 600; z-index: 999; display: flex; align-items: center; gap: 6px; }
        .firebase-status.active { border: 2px solid #28a745; color: #28a745; }
        .firebase-status.inactive { border: 2px solid #ffc107; color: #ffc107; }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; }
        .status-dot.active { background: #28a745; animation: pulse 2s infinite; }
        .status-dot.inactive { background: #ffc107; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    
        
        /* Loading indicator */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        .loading-overlay.show {
            display: flex;
        }
        .loading-spinner {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2d7a3e;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

       /* Complete Button Styles */
.complete-btn {
    background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
    color: white;
    border: none;
    padding: 4px 12px;        /* ← SMALLER PADDING */
    border-radius: 4px;       /* ← SMALLER RADIUS */
    cursor: pointer;
    font-size: 11px;          /* ← SMALLER FONT */
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(76, 175, 80, 0.3);
    text-transform: uppercase;
    letter-spacing: 0.3px;    /* ← SMALLER SPACING */
}
        .complete-btn:hover {
            background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.4);
            transform: translateY(-2px);
        }
        .complete-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(76, 175, 80, 0.3);
        }

        /* Slide in/out animations for notification */
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

    </style>
</head>
<body>

    <!-- Login Page -->
    <div id="loginPage">
        <div class="login-card">
            <div class="login-logo">
                <img src="data:image/png;base64,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" alt="Evergreen Metal Works">
            </div>
            <h1 class="login-title">Production Tracker</h1>
            <p class="login-subtitle">Evergreen Metal Works</p>
            <div class="login-error" id="loginError">Invalid username or password!</div>
            <div class="login-form-group">
                <label>Username</label>
                <input type="text" id="loginUsername" placeholder="Enter username" autocomplete="username">
            </div>
            <div class="login-form-group">
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="Enter password" autocomplete="current-password">
            </div>
            <button class="login-btn" onclick="handleLogin()">Login</button>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-wrapper">
        <div class="container">
            <div class="header">
                <div class="header-left">
                    <div class="header-logo">
                        <img src="data:image/png;base64,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" alt="Evergreen">
                    </div>
                    <div class="header-text">
                        <h1>📋 Production Tracker</h1>
                        <p>Digital Reporting System</p>
                    </div>
                </div>
                <div class="header-right">
                    <button class="data-btn" onclick="exportData()">📥 Export</button>
                    <button class="data-btn import" onclick="document.getElementById('importFile').click()">📤 Import</button>
                    <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importData(this)">
                    <span class="user-badge" id="userBadge">User</span>
                    <button class="logout-btn" onclick="handleLogout()">Logout</button>
                </div>
            </div>

            <div class="tab-container" id="tabContainer">
                <button class="tab active" data-tab="reporter">Reporter</button>
                <button class="tab" data-tab="dashboard">Dashboard</button>
                <button class="tab" data-tab="upload">Add Job Card</button>
                <button class="tab" data-tab="manage">Manage Jobs</button>
                <button class="tab" data-tab="monthly">Monthly Report</button>
                <button class="tab" data-tab="customers">Customers</button>
            </div>

            <!-- Reporter Tab -->
            <div id="reporter" class="content active">
                <div class="success-msg" id="successMsg">✓ Entry recorded successfully!</div>
                <div class="card">
                    <h3 style="color: #2d7a3e; margin-bottom: 15px;">Select Production Type</h3>
                    <div class="form-group">
                        <label>Production Type</label>
                        <select id="productionTypeFilter">
                            <option value="">All Types</option>
                            <option value="Normal">Normal</option>
                            <option value="Step Lap">Step Lap</option>
                        </select>
                    </div>
                </div>
                <div class="sub-tab-container">
                    <button class="sub-tab active" data-subtab="started">Started</button>
                    
                </div>
                <div class="card">
                    <h2 style="color: #2d7a3e; margin-bottom: 20px;">Record Production</h2>
                    <div class="form-group">
                        <label>Job Card Number</label>
                        <select id="jobCard"><option value="">Select Job Card</option></select>
                    </div>
                    <div id="jobDetailsRow" class="info-row" style="display: none;">
                        <div class="info-item"><label>Job Card No.</label><div class="value" id="displayJobCard">-</div></div>
                        <div class="info-item"><label>Work Order</label><div class="value" id="displayWorkOrder">-</div></div>
                        <div class="info-item"><label>Rating</label><div class="value" id="displayRating">-</div></div>
                    </div>
                    <div id="additionalDetails" style="display: none; padding: 10px; background: #e8f5e9; border-radius: 8px; margin-bottom: 20px; font-size: 13px; color: #555;">
                        <span id="detailsText"></span>
                    </div>
                    <div id="centreMMSection" class="form-group" style="display: none;">
                        <label>Diamond/Centre MM (For Normal Production)</label>
                        <input type="text" id="diamondMM" placeholder="e.g., 0.5, 0.0, 1.0, 1.5">
                    </div>
                    <div class="form-group">
                        <label>Machine</label>
                        <select id="machine">
                            <option value="">Select Machine</option>
                            <option value="CTL-400">CTL-400</option>
                            <option value="CTL-300">CTL-300</option>
                            <option value="CTL-600">CTL-600</option>
                            <option value="CTL-150">CTL-150</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Operator Name</label>
                        <input type="text" id="operatorName" placeholder="Enter operator name">
                    </div>
                    <div class="form-group">
                        <label>Item Type</label>
                        <select id="itemType">
                            <option value="">Select Item Type</option>
                            <option value="yoke-side">Yoke/Side</option>
                            <option value="centre">Centre</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Width (mm)</label>
                        <div class="width-grid" id="widthGrid"></div>
                    </div>
                    <div class="form-group">
                        <label>Remarks (Optional)</label>
                        <textarea id="remarks" placeholder="Add any notes or observations..."></textarea>
                    </div>
                    <button class="submit-btn" id="recordBtn">Record Entry</button>
                </div>
                <div class="card">
                    <h3 style="color: #2d7a3e; margin-bottom: 15px;" id="entriesHeader">Started Production</h3>
                    <div class="production-list" id="productionList">
                        <p style="text-align: center; color: #999;">No started items yet</p>
                    </div>
                </div>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard" class="content">
                <div class="card">
                    <div class="form-group">
                        <label>Select Job Card</label>
                        <select id="dashboardJobCard"></select>
                    </div>
                    <div id="dashboardDetailsRow" class="info-row">
                        <div class="info-item"><label>Job Card No.</label><div class="value" id="dashDisplayJobCard">-</div></div>
                        <div class="info-item"><label>Work Order</label><div class="value" id="dashDisplayWorkOrder">-</div></div>
                        <div class="info-item"><label>Rating</label><div class="value" id="dashDisplayRating">-</div></div>
                    </div>
                    <div id="dashAdditionalDetails" style="padding: 10px; background: #e8f5e9; border-radius: 8px; margin-bottom: 20px; font-size: 13px; color: #555;">
                        <span id="dashDetailsText">-</span>
                    </div>
                    <div class="progress-header">
                        <h3>Overall Progress</h3>
                        <span class="progress-percent" id="overallPercent">0%</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="overallProgress" style="width: 0%"><span></span></div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-box"><h4>Completed Blades</h4><p id="completedBlades">0</p></div>
                        <div class="stat-box"><h4>Total Blades</h4><p id="totalBlades">0</p></div>
                        <div class="stat-box"><h4>Completed Weight</h4><p id="completedWeight">0 kg</p></div>
                        <div class="stat-box"><h4>Total Weight</h4><p id="totalWeight">0 kg</p></div>
                    </div>
                </div>
                <div class="card">
                    <h3 style="color: #333; margin-bottom: 20px;">Section Progress</h3>
                    <div class="group-progress">
                        <div class="group-header"><span id="section1Label">Side</span><span id="group1Percent">0%</span></div>
                        <div class="group-bar"><div class="group-fill" id="group1Progress" style="width: 0%"></div></div>
                    </div>
                    <div class="group-progress">
                        <div class="group-header"><span id="section2Label">Yoke</span><span id="group2Percent">0%</span></div>
                        <div class="group-bar"><div class="group-fill" id="group2Progress" style="width: 0%"></div></div>
                    </div>
                    <div class="group-progress">
                        <div class="group-header"><span id="section3Label">Centre</span><span id="group3Percent">0%</span></div>
                        <div class="group-bar"><div class="group-fill" id="group3Progress" style="width: 0%"></div></div>
                    </div>
                </div>
                <div class="card">
                    <h3 style="color: #2d7a3e; margin-bottom: 15px;">Production Details</h3>
                    <div class="table-section">
                        <h4>🔹 Yoke/Side Production</h4>
                        <div style="overflow-x: auto;">
                            <table class="production-table">
                                <thead><tr><th>Width (mm)</th><th>Blades</th><th>Status</th><th>Action</th></tr></thead>
                                <tbody id="yokeSideTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="table-section">
                        <h4>🔹 Centre Production</h4>
                        <div style="overflow-x: auto;">
                            <table class="production-table">
                                <thead><tr><th>Width (mm)</th><th>Blades</th><th>Status</th><th>Action</th></tr></thead>
                                <tbody id="centreTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="timestamp" id="lastUpdate">Last updated: Never</div>
            </div>

            <!-- Add Job Card Tab -->
            <div id="upload" class="content">
                <div class="card">
                    <h2 style="color: #2d7a3e; margin-bottom: 20px;">Add New Job Card</h2>
                    <div class="success-msg" id="uploadSuccessMsg">✓ Job card added successfully!</div>
                    <div class="error-msg" id="uploadErrorMsg">✗ Error processing file.</div>
                    <p style="color: #666; margin-bottom: 20px; font-size: 14px;"><strong>📋 Copy-Paste Method:</strong><br>
                    1. Fill basic details below<br>2. Copy data from Excel (including headers)<br>3. Paste into each section<br>4. Click "Parse & Save"</p>
                    <div class="form-group"><label>Job Card Number *</label><input type="text" id="pasteJobCard" placeholder="e.g., EG25-751"></div>
                    <div class="form-group"><label>Work Order Number *</label><input type="text" id="pasteWorkOrder" placeholder="e.g., S-453"></div>
                    <div class="form-group"><label>Production Type *</label>
                        <select id="pasteProductionType">
                            <option value="">Select Production Type</option>
                            <option value="Normal">Normal</option>
                            <option value="Normal-0mm">Normal-0mm</option>
                            <option value="Step Lap">Step Lap</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Rating</label><input type="text" id="pasteRating" placeholder="e.g., 1600 KVA (optional)"></div>
                    <div class="form-group"><label>Grade *</label>
                        <select id="pasteGrade"><option value="M4">M4</option><option value="MOH">MOH</option><option value="M3">M3</option><option value="ZDKH">ZDKH</option><option value="M5">M5</option></select>
                    </div>
                    <div class="form-group"><label>Thickness *</label>
                        <select id="pasteThickness"><option value="0.23">0.23mm</option><option value="0.27">0.27mm</option><option value="0.30">0.30mm</option><option value="0.35">0.35mm</option></select>
                    </div>
                    <div class="form-group"><label>Customer Name (Optional)</label><input type="text" id="pasteCustomer" placeholder="e.g., VIJI"></div>
                    <h4 style="color: #2d7a3e; margin: 30px 0 10px; padding-top: 20px; border-top: 2px solid #e8f5e9;">📋 Side Production Data (Group 1)</h4>
                    <div class="form-group"><label>Side Data</label><textarea id="sideData" placeholder="Paste entire table from Excel here..."></textarea></div>
                    <h4 style="color: #2d7a3e; margin: 30px 0 10px;">📋 Yoke Production Data (Group 2)</h4>
                    <div class="form-group"><label>Yoke Data</label><textarea id="yokeData" placeholder="Paste entire table from Excel here..."></textarea></div>
                    <h4 style="color: #2d7a3e; margin: 30px 0 10px;">📋 Centre Production Data (Group 3)</h4>
                    <div class="form-group"><label>Centre Data</label><textarea id="centreData" placeholder="Paste entire table from Excel here..."></textarea></div>
                    <button class="submit-btn" id="parseBtn">Parse & Save Job Card</button>
                </div>
            </div>

            <!-- Manage Jobs Tab -->
            <div id="manage" class="content">
                <div class="card">
                    <h2 style="color: #2d7a3e; margin-bottom: 20px;">Manage Job Cards</h2>
                    <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                        <strong>Archive:</strong> Removes from Reporter but keeps in reports<br>
                        <strong>Hold:</strong> Temporarily pauses job (removes from Reporter)<br>
                        <strong>Delete:</strong> Permanently removes ALL data (cannot be undone!)
                    </p>
                    <div class="job-card-list" id="jobCardList"></div>
                </div>
            </div>

            <!-- Monthly Report Tab -->
            <div id="monthly" class="content">
                <div class="card">
                    <h2 style="color: #2d7a3e; margin-bottom: 20px;">Monthly Production Report</h2>
                    <div class="month-selector">
                        <select id="reportMonth">
                            <option value="0">January</option><option value="1">February</option><option value="2">March</option><option value="3">April</option>
                            <option value="4">May</option><option value="5">June</option><option value="6">July</option><option value="7">August</option>
                            <option value="8">September</option><option value="9">October</option><option value="10">November</option><option value="11">December</option>
                        </select>
                        <select id="reportYear"><option value="2024">2024</option><option value="2025">2025</option><option value="2026" selected>2026</option><option value="2027">2027</option></select>
                        <button class="export-btn" id="exportBtn">📥 Export to Excel</button>
                    </div>
                    <div class="report-summary">
                        <div class="summary-box"><h4>Total Job Cards</h4><p id="monthlyJobCards">0</p></div>
                        <div class="summary-box"><h4>Completed Jobs</h4><p id="monthlyCompleted">0</p></div>
                        <div class="summary-box"><h4>Pending Jobs</h4><p id="monthlyPending">0</p></div>
                        
                    </div>
                    <div class="card" style="background: #f8f9fa;">
                        <h3 style="color: #2d7a3e; margin-bottom: 15px;">Production Trend</h3>
                        <div class="chart-container"><canvas id="monthlyChart"></canvas></div>
                    </div>
                    <h3 style="color: #333; margin-top: 30px; margin-bottom: 15px;">Job Card Details</h3>
                    <div id="monthlyJobList"><p style="text-align: center; color: #999;">No production data for selected month</p></div>
                </div>
            </div>

            <!-- Customers Tab -->
            <div id="customers" class="content">
                <div class="card">
                    <h2 style="color: #2d7a3e; margin-bottom: 20px;">👥 Customer Orders</h2>
                    <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                        Click on a customer to view all their orders and completion status
                    </p>
                    <div id="customersList"></div>
                </div>
            </div>

        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="orderModal" class="order-modal">
        <div class="order-modal-content">
            <span class="modal-close" onclick="closeOrderModal()">&times;</span>
            <div id="orderModalContent"></div>
        </div>
    </div>

    <script>

// ========================================
// FIREBASE CONFIGURATION (PASTE YOUR CONFIG HERE)
// ========================================

// 📝 INSTRUCTIONS: After you create your Firebase project:
// 1. Go to Firebase Console → Project Settings → Your apps → Web app
// 2. Copy your config values
// 3. Replace the values below with YOUR values
// 4. Save and upload

const firebaseConfig = {
  apiKey: "AIzaSyCWSaMePMKIKZqJNCgJf2xabITJzS_o7no",
  authDomain: "production-tracker-test.firebaseapp.com",
  projectId: "production-tracker-test",
  storageBucket: "production-tracker-test.firebasestorage.app",
  messagingSenderId: "494949012026",
  appId: "1:494949012026:web:362368c328be14f4e49b03"
};

// Firebase initialization (safe - won't break if config is empty)
let db = null;
let firebaseActive = false;

function initFirebase() {
    // Check if config is provided
    if (!firebaseConfig.apiKey || !firebaseConfig.projectId) {
        
        firebaseActive = false;
        return;
    }
    
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        firebaseActive = true;
        
        setupFirebaseListeners();
    } catch (error) {
        console.error("⚠️ Firebase init error:", error);
        
        firebaseActive = false;
    }
}

// Flag to prevent infinite loop when Firebase listener triggers a save
// ============================================================================
// SCALABLE FIREBASE LAYER
// Proper Firestore structure - one document per item, scales to 10,000+
//
// Collections:
//   jobCards/{jobCardId}            – one small doc per job card
//   productions/{entryId}           – one small doc per production entry
//   completedItems/{jobCardId}      – one doc per job card's completions
// ============================================================================

let receivingFromFirebase = false;  // Prevents write-back loops

// ── Only runs UI updates when the user is logged in ───────────────────────
function safeUIUpdate(fn) {
    const appWrapper = document.querySelector('.app-wrapper');
    if (appWrapper && appWrapper.classList.contains('show')) {
        try { fn(); } catch(e) { console.warn('UI update error:', e); }
    }
}

// ── WRITE a single job card ───────────────────────────────────────────────
function saveJobCardToFirebase(jobCardId, data) {
    if (!firebaseActive || !db) return;
    db.collection('jobCards').doc(jobCardId).set(data)
        .then(() => console.log('☁️ Saved jobCard:', jobCardId))
        .catch(err => console.warn('⚠️ Firebase jobCard write failed:', err.message));
}

// ── WRITE a single production entry ──────────────────────────────────────
function saveProductionEntryToFirebase(entry) {
    if (!firebaseActive || !db) return;
    db.collection('productions').doc(String(entry.id)).set(entry)
        .then(() => console.log('☁️ Saved production entry:', entry.id))
        .catch(err => console.warn('⚠️ Firebase production write failed:', err.message));
}

// ── WRITE completed items for ONE job card ────────────────────────────────
function saveCompletedItemsForJob(jobCardId) {
    if (!firebaseActive || !db) return;
    // Extract only the keys that belong to this job card
    const jobKeys = {};
    Object.keys(completedItems).forEach(k => {
        if (k.startsWith(jobCardId + '-')) jobKeys[k] = true;
    });
    db.collection('completedItems').doc(jobCardId).set({ items: jobKeys })
        .then(() => console.log('☁️ Saved completedItems for:', jobCardId))
        .catch(err => console.warn('⚠️ Firebase completedItems write failed:', err.message));
}

// ── DELETE a job card and its related data ────────────────────────────────
function deleteJobCardFromFirebase(jobCardId) {
    if (!firebaseActive || !db) return;
    db.collection('jobCards').doc(jobCardId).delete()
        .catch(err => console.warn('⚠️ Firebase delete failed:', err.message));
    db.collection('completedItems').doc(jobCardId).delete()
        .catch(err => console.warn('⚠️ Firebase completedItems delete failed:', err.message));
}

// ── DELETE a production entry ─────────────────────────────────────────────
function deleteProductionEntryFromFirebase(entryId) {
    if (!firebaseActive || !db) return;
    db.collection('productions').doc(String(entryId)).delete()
        .catch(err => console.warn('⚠️ Firebase entry delete failed:', err.message));
}

// ── REAL-TIME LISTENERS ───────────────────────────────────────────────────
function setupFirebaseListeners() {
    if (!firebaseActive || !db) return;

    // 1. Listen to ALL job cards (collection-level listener)
    db.collection('jobCards').onSnapshot(snapshot => {
        if (receivingFromFirebase) return;
        receivingFromFirebase = true;
        snapshot.docChanges().forEach(change => {
            const id = change.doc.id;
            if (change.type === 'removed') {
                delete jobCardData[id];
            } else {
                jobCardData[id] = change.doc.data();
            }
        });
        invalidateCache();
        localStorage.setItem('jobCardData', JSON.stringify(jobCardData));
        safeUIUpdate(() => {
            populateJobCardDropdowns();
            displayJobCardList();
            if (typeof updateMonthlyReport === 'function') updateMonthlyReport();
        });
        receivingFromFirebase = false;
        console.log('🔄 jobCards synced from Firebase');
    }, err => console.warn('⚠️ jobCards listener error:', err.message));

    // 2. Listen to ALL production entries (collection-level listener)
    db.collection('productions').onSnapshot(snapshot => {
        if (receivingFromFirebase) return;
        receivingFromFirebase = true;
        snapshot.docChanges().forEach(change => {
            const entry = change.doc.data();
            const idx = productionEntries.findIndex(e => String(e.id) === change.doc.id);
            if (change.type === 'removed') {
                if (idx !== -1) productionEntries.splice(idx, 1);
            } else {
                if (idx !== -1) productionEntries[idx] = entry;
                else productionEntries.push(entry);
            }
        });
        localStorage.setItem('productionEntries', JSON.stringify(productionEntries));
        safeUIUpdate(() => {
            displayProductionList();
            if (typeof updateMonthlyReport === 'function') updateMonthlyReport();
        });
        receivingFromFirebase = false;
        console.log('🔄 productions synced from Firebase');
    }, err => console.warn('⚠️ productions listener error:', err.message));

    // 3. Listen to ALL completedItems docs (one per job card)
    db.collection('completedItems').onSnapshot(snapshot => {
        if (receivingFromFirebase) return;
        receivingFromFirebase = true;
        snapshot.docChanges().forEach(change => {
            const data = change.doc.data();
            if (change.type === 'removed') {
                // Remove all keys for this job card
                Object.keys(completedItems).forEach(k => {
                    if (k.startsWith(change.doc.id + '-')) delete completedItems[k];
                });
            } else if (data.items) {
                Object.assign(completedItems, data.items);
            }
        });
        localStorage.setItem('completedItems', JSON.stringify(completedItems));
        safeUIUpdate(() => {
            updateDashboard();
            displayProductionList();
            displayJobCardList();
            if (typeof updateMonthlyReport === 'function') updateMonthlyReport();
        });
        receivingFromFirebase = false;
        console.log('🔄 completedItems synced from Firebase');
    }, err => console.warn('⚠️ completedItems listener error:', err.message));

    console.log('✅ Firebase real-time listeners active (scalable mode)');
}

// ── UNIFIED SAVE (localStorage + Firebase) ───────────────────────────────
// Call this for jobCardData and completedItems (legacy keys)
// For production entries, call saveProductionEntry() directly
function saveData(key, data) {
    // Always save to localStorage immediately
    try {
        localStorage.setItem(key, JSON.stringify(data));
    } catch(e) { console.error('localStorage error:', e); }

    if (key === 'jobCardData') invalidateCache();
    if (receivingFromFirebase) return;

    // For each key, write to the correct Firebase collection
    if (key === 'jobCardData') {
        // Write each job card that changed to its own document
        Object.keys(data).forEach(jobCardId => {
            saveJobCardToFirebase(jobCardId, data[jobCardId]);
        });
    } else if (key === 'completedItems') {
        // Group by job card and write one doc per job card
        const byJob = {};
        Object.keys(data).forEach(k => {
            const jobCardId = k.split('-').slice(0, 2).join('-'); // e.g. "EG25-814"
            if (!byJob[jobCardId]) byJob[jobCardId] = {};
            byJob[jobCardId][k] = true;
        });
        Object.keys(byJob).forEach(jobCardId => {
            db.collection('completedItems').doc(jobCardId).set({ items: byJob[jobCardId] })
                .catch(err => console.warn('⚠️ completedItems write failed:', err.message));
        });
    } else if (key === 'productionEntries') {
        // Write each entry to its own document
        data.forEach(entry => saveProductionEntryToFirebase(entry));
    }
}

// ── SAVE a single production entry (most efficient path) ─────────────────
function saveProductionEntry(entry) {
    const idx = productionEntries.findIndex(e => e.id === entry.id);
    if (idx !== -1) productionEntries[idx] = entry;
    else productionEntries.push(entry);
    localStorage.setItem('productionEntries', JSON.stringify(productionEntries));
    if (!receivingFromFirebase) saveProductionEntryToFirebase(entry);
}

function loadData(key) {
    const localData = localStorage.getItem(key);
    return localData ? JSON.parse(localData) : null;
}

// Initialize Firebase when page loads
document.addEventListener('DOMContentLoaded', function() {
    initFirebase();
    
    // Migration: Add dateAdded to existing job cards that don't have it
    setTimeout(function() {
        let needsSave = false;
        Object.keys(jobCardData).forEach(jobCard => {
            if (!jobCardData[jobCard].dateAdded) {
                jobCardData[jobCard].dateAdded = new Date().toISOString();
                needsSave = true;
            }
        });
        if (needsSave) {
            localStorage.setItem('jobCardData', JSON.stringify(jobCardData));
            console.log('✓ Added dateAdded to existing job cards');
        }
    }, 1000);
});


// ========================================
// LOGIN SYSTEM
// ========================================

const USERS = {
    'Reporter@Evergreen': { 
        password: '1234', 
        role: 'Reporter', 
        tabs: ['reporter', 'dashboard', 'monthly'] 
    },
    'Management@Evergreen': { 
        password: '0000', 
        role: 'Management', 
        tabs: ['reporter', 'dashboard', 'upload', 'manage', 'monthly', 'customers'] 
    },
    'Headoffice@Evergreen': { 
        password: '5253', 
        role: 'Head Office', 
        tabs: ['dashboard', 'manage', 'monthly', 'customers'] 
    }
};

let currentUser = null;

function handleLogin() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    const errorDiv = document.getElementById('loginError');
    
    if (USERS[username] && USERS[username].password === password) {
        currentUser = { username, ...USERS[username] };
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        showApp();
    } else {
        errorDiv.classList.add('show');
        setTimeout(() => errorDiv.classList.remove('show'), 3000);
    }
}

function showApp() {
    document.getElementById('loginPage').classList.add('hidden');
    document.querySelector('.app-wrapper').classList.add('show');
    setupUserInterface();
    initializeApp();
}

function handleLogout() {
    if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('currentUser');
        location.reload();
    }
}

function setupUserInterface() {
    // Update user badge
    document.getElementById('userBadge').textContent = currentUser.role;
    
    // Show/hide tabs based on user role
    const allTabs = document.querySelectorAll('.tab');
    allTabs.forEach(tab => {
        const tabName = tab.getAttribute('data-tab');
        if (currentUser.tabs.includes(tabName)) {
            tab.style.display = 'inline-block';
        } else {
            tab.style.display = 'none';
        }
    });
    
    // Set first available tab as active
    const firstTab = document.querySelector('.tab[style*="inline-block"]');
    if (firstTab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        firstTab.classList.add('active');
        const tabName = firstTab.getAttribute('data-tab');
        document.getElementById(tabName).classList.add('active');
    }
}

// ========================================
// DATA STORAGE
// ========================================

let jobCardData = {};


// ============================================================================
// PERFORMANCE OPTIMIZATION - Pagination & Limits
// ============================================================================

const ITEMS_PER_PAGE = 50; // Show 50 items at a time
let currentPage = 1;
let jobCardCache = null;
let lastCacheUpdate = 0;
const CACHE_DURATION = 5000; // Cache for 5 seconds

let productionEntries = JSON.parse(localStorage.getItem('productionEntries')) || [];
let completedItems = JSON.parse(localStorage.getItem('completedItems')) || {};
let currentSubTab = 'started';
let monthlyChart = null;

// Load job card data
const savedJobCards = localStorage.getItem('jobCardData');
if (savedJobCards) {
    jobCardData = JSON.parse(savedJobCards);
}

// ========================================
// INITIALIZATION
// ========================================

function initializeApp() {
    initializeTabs();
    initializeSubTabs();
    populateJobCardDropdowns();
    updateDashboard();
    displayProductionList();
    setCurrentMonth();
    displayJobCardList();
    displayCustomers();
    
    // Event listeners
    
// ============================================================================
// PERFORMANCE OPTIMIZATIONS
// ============================================================================

// Debounce utility to prevent rapid-fire function calls
function debounce(func, delay) {
    let timeoutId;
    return function(...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(this, args), delay);
    };
}

// Flag to prevent cascading updates
let isUpdating = false;

// Optimized job card selection handler
function handleJobCardSelection() {
    if (isUpdating) return;
    isUpdating = true;
    
    try {
        populateJobCardDetails();
        updateWidths();
    } finally {
        setTimeout(() => { isUpdating = false; }, 100);
    }
}

// Optimized dashboard selection handler
function handleDashboardSelection() {
    if (isUpdating) return;
    isUpdating = true;
    
    try {
        updateDashboard();
    } finally {
        setTimeout(() => { isUpdating = false; }, 100);
    }
}

// Debounced versions (300ms delay for smooth performance)
const debouncedJobCardHandler = debounce(handleJobCardSelection, 300);
const debouncedDashboardHandler = debounce(handleDashboardSelection, 300);


const jobCardSelect = document.getElementById('jobCard');
    if (jobCardSelect) {
        // Remove any existing listeners (prevent duplicates)
        jobCardSelect.removeEventListener('change', updateJobDetails);
        
        // Add new listener with immediate execution
        jobCardSelect.addEventListener('change', function(e) {
            console.log('Job card dropdown changed to:', e.target.value);
            // Force immediate execution
            try {
                updateJobDetails();
            } catch (error) {
                console.error('Error in updateJobDetails:', error);
            }
        }, false);
        
        console.log('Job card event listener attached');
    } else {
        console.error('Job card select element not found!');
    }
    document.getElementById('itemType').addEventListener('change', updateWidths);
    document.getElementById('productionTypeFilter').addEventListener('change', filterJobCardsByType);
    document.getElementById('dashboardJobCard').addEventListener('change', debouncedDashboardHandler);
    document.getElementById('reportMonth').addEventListener('change', updateMonthlyReport);
    document.getElementById('reportYear').addEventListener('change', updateMonthlyReport);
    document.getElementById('recordBtn').addEventListener('click', recordProduction);
    document.getElementById('parseBtn').addEventListener('click', parsePastedData);
    document.getElementById('exportBtn').addEventListener('click', exportMonthlyReport);
}

function initializeTabs() {
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');
            switchTab(tabName, this);
        });
    });
}

function initializeSubTabs() {
    document.querySelectorAll('.sub-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const subTabName = this.getAttribute('data-subtab');
            switchSubTab(subTabName, this);
        });
    });
}

function switchTab(tab, element) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
    
    if (element) {
        element.classList.add('active');
    }
    document.getElementById(tab).classList.add('active');
    
    if (tab === 'dashboard') {
        updateDashboard();
    } else if (tab === 'monthly') {
        updateMonthlyReport();
    } else if (tab === 'manage') {
        displayJobCardList();
    } else if (tab === 'customers') {
        displayCustomers();
    }
}

function switchSubTab(subTab, element) {
    currentSubTab = subTab;
    document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
    if (element) {
        element.classList.add('active');
    }
    displayProductionList();
}

// ========================================
// PRODUCTION TYPE FILTERING
// ========================================

function filterJobCardsByType() {
    const selectedType = document.getElementById('productionTypeFilter').value;
    const reporterSelect = document.getElementById('jobCard');
    
    reporterSelect.innerHTML = '<option value="">Select Job Card</option>';
    
    Object.keys(jobCardData).forEach(jobCard => {
        const data = jobCardData[jobCard];
        if (!data.held) {
            if (!selectedType || data.productionType === selectedType) {
                const option = document.createElement('option');
                option.value = jobCard;
                option.textContent = jobCard;
                reporterSelect.appendChild(option);
            }
        }
    });
    
    document.getElementById('jobCard').value = '';
    document.getElementById('jobDetailsRow').style.display = 'none';
    document.getElementById('additionalDetails').style.display = 'none';
    document.getElementById('itemType').value = '';
    document.getElementById('widthGrid').innerHTML = '';
    
    const centreMMSection = document.getElementById('centreMMSection');
    if (selectedType === 'Normal') {
        centreMMSection.style.display = 'block';
    } else {
        centreMMSection.style.display = 'none';
    }
}



// Sort job cards in descending order (newest first)
function sortJobCards(jobCards) {
    return jobCards.sort((a, b) => {
        // Extract numbers from job card strings (e.g., "EG25-814" -> 814)
        const numA = parseInt(a.split('-').pop()) || 0;
        const numB = parseInt(b.split('-').pop()) || 0;
        return numB - numA; // Descending order
    });
}

// Get job cards with caching for performance


// Invalidate cache when data changes
function invalidateCache() {
    jobCardCache = null;
    lastCacheUpdate = 0;
}


function getJobCardsList(forceRefresh = false) {
    const now = Date.now();
    
    // Use cache if valid and not forced refresh
    if (!forceRefresh && jobCardCache && (now - lastCacheUpdate) < CACHE_DURATION) {
        return jobCardCache;
    }
    
    // Rebuild cache
    const cards = Object.keys(jobCardData).filter(jc => !jobCardData[jc].archived);
    jobCardCache = sortJobCards(cards);
    lastCacheUpdate = now;
    
    return jobCardCache;
}


function populateJobCardDropdowns() {
    const jobCards = getJobCardsList(); // Sorted, cached list
    
    // Populate Reporter dropdown (jobCard)
    const reporterSelect = document.getElementById('jobCard');
    if (reporterSelect) {
        const currentValue = reporterSelect.value; // Preserve selection
        reporterSelect.innerHTML = '<option value="">Select Job Card</option>';
        
        jobCards.forEach(jobCard => {
            const data = jobCardData[jobCard];
            const option = document.createElement('option');
            option.value = jobCard;
            let label = jobCard;
            if (data.held) label += ' (On Hold)';
            option.textContent = label;
            reporterSelect.appendChild(option);
        });
        
        if (currentValue) reporterSelect.value = currentValue; // Restore selection
    }
    
    // Populate Dashboard dropdown (dashboardJobCard)
    const dashboardSelect = document.getElementById('dashboardJobCard');
    if (dashboardSelect) {
        const currentValue = dashboardSelect.value; // Preserve selection
        dashboardSelect.innerHTML = '<option value="">Select Job Card</option>';
        
        jobCards.forEach(jobCard => {
            const data = jobCardData[jobCard];
            const option = document.createElement('option');
            option.value = jobCard;
            let label = jobCard;
            if (data.held) label += ' (On Hold)';
            option.textContent = label;
            dashboardSelect.appendChild(option);
        });
        
        if (currentValue) dashboardSelect.value = currentValue; // Restore selection
    }
    
    console.log('Dropdowns populated with', jobCards.length, 'job cards (sorted)');
}

// ========================================
// JOB DETAILS
// ========================================

function updateJobDetails() {
    const jobCard = document.getElementById('jobCard').value;
    const detailsRow = document.getElementById('jobDetailsRow');
    const additionalDetails = document.getElementById('additionalDetails');
    
    console.log('updateJobDetails called, job card:', jobCard);
    
    if (!jobCard || !jobCardData[jobCard]) {
        if (detailsRow) detailsRow.style.display = 'none';
        if (additionalDetails) additionalDetails.style.display = 'none';
        const widthGrid = document.getElementById('widthGrid');
        if (widthGrid) widthGrid.innerHTML = '';
        return;
    }

    const data = jobCardData[jobCard];
    console.log('Job card data loaded:', data);
    
    document.getElementById('displayJobCard').textContent = jobCard;
    document.getElementById('displayWorkOrder').textContent = data.workOrder;
    document.getElementById('displayRating').textContent = data.rating;
    detailsRow.style.display = 'grid';

    let details = `Type: ${data.productionType} | Grade: ${data.grade} | Thickness: ${data.thickness} | Process: ${data.process}`;
    if (data.customer) {
        details += ` | Customer: ${data.customer}`;
    }
    document.getElementById('detailsText').textContent = details;
    additionalDetails.style.display = 'block';

    document.getElementById('itemType').value = '';
    updateWidths();
}

function updateWidths() {
    updateCentreMMVisibility();
    const itemType = document.getElementById('itemType').value;
    const jobCard = document.getElementById('jobCard').value;
    const widthGrid = document.getElementById('widthGrid');
    
    if (!itemType) {
        widthGrid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #999;">Select an item type first</p>';
        return;
    }

    if (!jobCard) {
        widthGrid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #999;">Select a job card first</p>';
        return;
    }

    const widths = Object.keys(jobCardData[jobCard].groups[1].widths).map(Number).sort((a, b) => b - a);
    
    widthGrid.innerHTML = '';
    widths.forEach(width => {
        const btn = document.createElement('button');
        btn.className = 'width-btn';
        btn.textContent = width + ' mm';
        btn.dataset.width = width;
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            selectWidth(this);
        });
        widthGrid.appendChild(btn);
    });
}

function selectWidth(element) {
    document.querySelectorAll('.width-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
    element.classList.add('selected');
}

// ========================================
// RECORD PRODUCTION
// ========================================

function recordProduction() {
    const jobCard = document.getElementById('jobCard').value;
    const machine = document.getElementById('machine').value;
    const operatorName = document.getElementById('operatorName').value.trim();
    const itemType = document.getElementById('itemType').value;
    const selectedWidth = document.querySelector('.width-btn.selected');
    const remarks = document.getElementById('remarks').value.trim();
    
    const productionType = document.getElementById('productionTypeFilter').value;
    let diamondMM = null;
    if (productionType === 'Normal') {
        diamondMM = document.getElementById('diamondMM').value;
        if (!diamondMM) {
            alert('Please select Diamond MM for Normal production');
            return;
        }
    }

    if (!jobCard || !machine || !operatorName || !itemType || !selectedWidth) {
        alert('Please fill all required fields');
        return;
    }

    const width = selectedWidth.dataset.width;
    const workOrder = jobCardData[jobCard].workOrder;
    const timestamp = new Date();
    
    const existingStarted = productionEntries.find(e => 
        e.jobCard === jobCard &&
        e.machine === machine &&
        e.itemType === itemType &&
        e.width === width &&
        (productionType === 'Normal' ? e.diamondMM === diamondMM : true) &&
        e.status === 'started' &&
        !e.endTime
    );

    if (existingStarted) {
        existingStarted.status = 'completed';
        existingStarted.endTime = timestamp.toISOString();
        existingStarted.endOperator = operatorName;
        if (remarks) {
            existingStarted.endRemarks = remarks;
        }
        
        if (itemType === 'yoke-side') {
            for (let group = 1; group <= 2; group++) {
                const key = diamondMM ? `${jobCard}-${group}-${width}-${diamondMM}` : `${jobCard}-${group}-${width}`;
                completedItems[key] = true;
            }
        } else if (itemType === 'centre') {
            const key = diamondMM ? `${jobCard}-3-${width}-${diamondMM}` : `${jobCard}-3-${width}`;
            completedItems[key] = true;
        }
        saveData('completedItems', completedItems);
    } else {
        const entry = {
            id: Date.now(),
            jobCard,
            workOrder,
            machine,
            operator: operatorName,
            itemType,
            width,
            productionType,
            diamondMM: diamondMM || null,
            status: 'started',
            startTime: timestamp.toISOString(),
            endTime: null,
            startRemarks: remarks || null,
            endRemarks: null
        };
        productionEntries.push(entry);
        saveProductionEntry(entry); // Write just this one entry to Firebase
    }

    // Always save full list to localStorage as backup
    localStorage.setItem('productionEntries', JSON.stringify(productionEntries));

    const successMsg = document.getElementById('successMsg');
    successMsg.classList.add('show');
    setTimeout(() => {
        successMsg.classList.remove('show');
    }, 3000);

    document.getElementById('operatorName').value = '';
    document.getElementById('remarks').value = '';
    document.getElementById('itemType').value = '';
    if (diamondMM) {
        document.getElementById('diamondMM').value = '';
    }
    document.getElementById('widthGrid').innerHTML = '';
    
    displayProductionList();
    updateDashboard();
}

// Continue in next message due to size...

// ========================================
// DISPLAY PRODUCTION LIST
// ========================================

function displayProductionList() {
    const listDiv = document.getElementById('productionList');
    const header = document.getElementById('entriesHeader');

    if (!listDiv || !header) return; // Guard: DOM not ready yet

    // Show ALL entries (both ongoing and completed) sorted newest first
    const allEntries = [...productionEntries].sort((a, b) =>
        new Date(b.startTime) - new Date(a.startTime)
    );

    header.textContent = 'Started Production';
    document.getElementById('recordBtn').textContent = 'Record Entry';

    if (allEntries.length === 0) {
        listDiv.innerHTML = '<p style="text-align: center; color: #999;">No production items yet</p>';
        return;
    }

    // PERFORMANCE: Show last 100 entries
    const MAX_DISPLAY = 100;
    const displayItems = allEntries.slice(0, MAX_DISPLAY);

    if (allEntries.length > MAX_DISPLAY) {
        header.textContent = `Started Production (Showing latest ${MAX_DISPLAY} of ${allEntries.length})`;
    }
    
    listDiv.innerHTML = displayItems.map(entry => {
        const startDate = new Date(entry.startTime);
        const endDate = entry.endTime ? new Date(entry.endTime) : null;
        
        let displayType = entry.productionType;
        if (entry.diamondMM) {
            displayType += ` (${entry.diamondMM})`;
        }
        
        // Show complete button only if not yet completed (no endTime)
        const completeBtn = !endDate ? 
            `<button onclick="completeStartedItem(${entry.id})" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; margin-top: 10px; float: right;">✓ Complete</button>` : '';
        
        // Green border for completed items
        const borderStyle = endDate ? 'border-left: 5px solid #28a745; background: #f8fff9;' : '';
        
        return `
            <div class="production-item" style="${borderStyle}">
                <h3>${entry.jobCard} - NO: ${entry.workOrder}</h3>
                <p><strong>Type:</strong> ${displayType} | <strong>Machine:</strong> ${entry.machine} | <strong>Item:</strong> ${entry.itemType} | <strong>Width:</strong> ${entry.width}mm</p>
                <p><strong>Operator:</strong> ${entry.operator}</p>
                <p class="time"><strong>Started:</strong> ${startDate.toLocaleString()}</p>
                ${endDate ? `<p class="time"><strong>Completed:</strong> ${endDate.toLocaleString()}</p>` : ''}
                ${entry.startRemarks ? `<div class="remark"><strong>Start Notes:</strong> ${entry.startRemarks}</div>` : ''}
                ${entry.endRemarks ? `<div class="remark"><strong>End Notes:</strong> ${entry.endRemarks}</div>` : ''}
                ${endDate && entry.endOperator ? `<p><strong>Completed by:</strong> ${entry.endOperator}</p>` : ''}
                ${completeBtn}
                <div style="clear: both;"></div>
            </div>
        `;
    }).join('');
}

// ========================================
// DASHBOARD
// ========================================

function updateDashboard() {
    const jobCard = document.getElementById('dashboardJobCard').value;
    
    if (!jobCard || !jobCardData[jobCard]) {
        return;
    }
    
    const data = jobCardData[jobCard];
    
    document.getElementById('dashDisplayJobCard').textContent = jobCard;
    document.getElementById('dashDisplayWorkOrder').textContent = data.workOrder;
    document.getElementById('dashDisplayRating').textContent = data.rating;
    
    let details = `Type: ${data.productionType} | Grade: ${data.grade} | Thickness: ${data.thickness} | Process: ${data.process}`;
    if (data.customer) {
        details += ` | Customer: ${data.customer}`;
    }
    document.getElementById('dashDetailsText').textContent = details;
    
    let totalBlades = 0;
    let completedBlades = 0;
    
    
    
    const groupProgress = [0, 0, 0];
    const groupTotals = [0, 0, 0];
    
    [1, 2, 3].forEach(groupNum => {
        const group = data.groups[groupNum];
        Object.keys(group.widths).forEach(width => {
            const widthData = group.widths[width];
            totalBlades += widthData.blades;
            
            groupTotals[groupNum - 1] += widthData.blades;
            
            if (data.productionType === 'Normal') {
                ['05mm', '00mm', '10mm'].forEach(mm => {
                    const key = `${jobCard}-${groupNum}-${width}-${mm}`;
                    if (completedItems[key]) {
                        const bladesPerMM = widthData.blades / 3;
                        
                        completedBlades += bladesPerMM;
                        
                        groupProgress[groupNum - 1] += bladesPerMM;
                    }
                });
            } else {
                const key = `${jobCard}-${groupNum}-${width}`;
                if (completedItems[key]) {
                    completedBlades += widthData.blades;
                    
                    groupProgress[groupNum - 1] += widthData.blades;
                }
            }
        });
    });
    
    const overallPercent = totalBlades > 0 ? Math.round((completedBlades / totalBlades) * 100) : 0;
    
    document.getElementById('completedBlades').textContent = Math.round(completedBlades);
    document.getElementById('totalBlades').textContent = totalBlades;
    
    
    document.getElementById('overallPercent').textContent = overallPercent + '%';
    
    const progressBar = document.getElementById('overallProgress');
    progressBar.style.width = overallPercent + '%';
    progressBar.querySelector('span').textContent = overallPercent + '%';
    
    [1, 2, 3].forEach(i => {
        const percent = groupTotals[i - 1] > 0 ? Math.round((groupProgress[i - 1] / groupTotals[i - 1]) * 100) : 0;
        document.getElementById(`group${i}Progress`).style.width = percent + '%';
        document.getElementById(`group${i}Percent`).textContent = percent + '%';
        document.getElementById(`section${i}Label`).textContent = data.groups[i].section;
    });
    
    updateProductionTables(jobCard, data);
    document.getElementById('lastUpdate').textContent = 'Last updated: ' + new Date().toLocaleString();
}

function updateProductionTables(jobCard, data) {
    const yokeSideBody = document.getElementById('yokeSideTableBody');
    const centreBody = document.getElementById('centreTableBody');
    
    if (!yokeSideBody || !centreBody) return;
    
    yokeSideBody.innerHTML = '';
    centreBody.innerHTML = '';
    
    [1, 2].forEach(groupNum => {
        const group = data.groups[groupNum];
        Object.keys(group.widths).sort((a, b) => b - a).forEach(width => {
            const widthData = group.widths[width];
            let isComplete = false;
            
            if (data.productionType === 'Normal') {
                const allMMComplete = ['05mm', '00mm', '10mm'].every(mm => {
                    const key = `${jobCard}-${groupNum}-${width}-${mm}`;
                    return completedItems[key];
                });
                isComplete = allMMComplete;
            } else {
                const key = `${jobCard}-${groupNum}-${width}`;
                isComplete = completedItems[key];
            }
            
            const row = document.createElement('tr');
            row.className = isComplete ? 'completed' : 'pending';
            
            // Create action button HTML
            let actionHTML = '';
            if (isComplete) {
                actionHTML = '<td><span style="color: #4caf50; font-weight: bold;">✓ Done</span></td>';
            } else {
                actionHTML = `<td><button class="complete-btn" onclick="markWidthComplete('${jobCard}', ${groupNum}, ${width}, '${data.productionType}')">Complete</button></td>`;
            }
            
            row.innerHTML = `
                <td>${width}mm</td>
                <td>${widthData.blades}</td>
                <td><span class="status-badge ${isComplete ? 'status-completed' : 'status-pending'}">${isComplete ? '✓ Done' : '⏳ Pending'}</span></td>
                ${actionHTML}
            `;
            yokeSideBody.appendChild(row);
        });
    });
    
    const group3 = data.groups[3];
    Object.keys(group3.widths).sort((a, b) => b - a).forEach(width => {
        const widthData = group3.widths[width];
        let isComplete = false;
        
        if (data.productionType === 'Normal') {
            const allMMComplete = ['05mm', '00mm', '10mm'].every(mm => {
                const key = `${jobCard}-3-${width}-${mm}`;
                return completedItems[key];
            });
            isComplete = allMMComplete;
        } else {
            const key = `${jobCard}-3-${width}`;
            isComplete = completedItems[key];
        }
        
        const row = document.createElement('tr');
        row.className = isComplete ? 'completed' : 'pending';
        
        // Create action button HTML
        let actionHTML = '';
        if (isComplete) {
            actionHTML = '<td><span style="color: #4caf50; font-weight: bold;">✓ Done</span></td>';
        } else {
            actionHTML = `<td><button class="complete-btn" onclick="markWidthComplete('${jobCard}', 3, ${width}, '${data.productionType}')">Complete</button></td>`;
        }
        
        row.innerHTML = `
            <td>${width}mm</td>
            <td>${widthData.blades}</td>
            <td><span class="status-badge ${isComplete ? 'status-completed' : 'status-pending'}">${isComplete ? '✓ Done' : '⏳ Pending'}</span></td>
            ${actionHTML}
        `;
        centreBody.appendChild(row);
    });
}

// ========================================
// MARK WIDTH AS COMPLETE (NEW FUNCTION)
// ========================================

function markWidthComplete(jobCard, groupNum, width, productionType) {
    // Show confirmation
    if (!confirm(`Mark ${width}mm (Group ${groupNum}) as complete?`)) {
        return;
    }
    
    // Mark as complete based on production type
    if (productionType === 'Normal') {
        // For Normal production, mark all 3 mm variations as complete
        ['05mm', '00mm', '10mm'].forEach(mm => {
            const key = `${jobCard}-${groupNum}-${width}-${mm}`;
            completedItems[key] = true;
        });
    } else {
        // For other production types, mark the width directly
        const key = `${jobCard}-${groupNum}-${width}`;
        completedItems[key] = true;
    }
    
    // Save to localStorage
    localStorage.setItem('completedItems', JSON.stringify(completedItems));
    
    // Save to Firebase if active
    saveCompletedItemsForJob(jobCard);
    
    // Refresh the display
    const data = jobCardData[jobCard];
    if (data) {
        updateProductionTables(jobCard, data);
        updateProgressBar(jobCard, data);
    }
    
    // Show success message
    showTemporaryMessage('✓ Width marked as complete!', 'success');
}

// Helper function to show temporary messages
function showTemporaryMessage(message, type = 'success') {
    const msgDiv = document.createElement('div');
    msgDiv.textContent = message;
    msgDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#4caf50' : '#f44336'};
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        z-index: 10000;
        font-weight: 500;
        animation: slideIn 0.3s ease-out;
    `;
    document.body.appendChild(msgDiv);
    
    setTimeout(() => {
        msgDiv.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => msgDiv.remove(), 300);
    }, 2000);
}

// ========================================
// PARSE PASTED DATA
// ========================================

function parsePastedData() {
    const jobCard = document.getElementById('pasteJobCard').value.trim();
    const workOrder = document.getElementById('pasteWorkOrder').value.trim();
    const productionType = document.getElementById('pasteProductionType').value;
    const rating = document.getElementById('pasteRating').value.trim();
    const grade = document.getElementById('pasteGrade').value;
    const thickness = document.getElementById('pasteThickness').value;
    const customer = document.getElementById('pasteCustomer').value.trim();
    
    const sideData = document.getElementById('sideData').value;
    const yokeData = document.getElementById('yokeData').value;
    const centreData = document.getElementById('centreData').value;
    
    if (!jobCard || !workOrder || !productionType || !grade || !thickness) {
        alert('Please fill all required fields (marked with *)');
        return;
    }
    
    if (!sideData || !yokeData || !centreData) {
        alert('Please paste data for all three groups');
        return;
    }
    
    try {
        const groups = {
            1: { section: 'Side', widths: parseWidthData(sideData) },
            2: { section: 'Yoke', widths: parseWidthData(yokeData) },
            3: { section: 'Centre', widths: parseWidthData(centreData) }
        };
        
        jobCardData[jobCard] = {
            workOrder,
            productionType,
            rating: rating || 'N/A',
            grade,
            thickness: thickness + 'mm',
            process: 'Standard',
            customer: customer || '',
            groups,
            archived: false,
            held: false,
            dateAdded: new Date().toISOString()  // Track when job card was added
        };
        
        saveData('jobCardData', jobCardData);
        
        document.getElementById('uploadSuccessMsg').classList.add('show');
        setTimeout(() => {
            document.getElementById('uploadSuccessMsg').classList.remove('show');
        }, 3000);
        
        document.getElementById('pasteJobCard').value = '';
        document.getElementById('pasteWorkOrder').value = '';
        document.getElementById('pasteProductionType').value = '';
        document.getElementById('pasteRating').value = '';
        document.getElementById('pasteCustomer').value = '';
        document.getElementById('sideData').value = '';
        document.getElementById('yokeData').value = '';
        document.getElementById('centreData').value = '';
        
        populateJobCardDropdowns();
        displayJobCardList();
        displayCustomers();
    } catch (error) {
        alert('Error parsing data: ' + error.message);
    }
}

function parseWidthData(data) {
    const lines = data.trim().split('\n');
    const widths = {};
    
    lines.forEach((line, index) => {
        if (index === 0) return;
        
        const parts = line.split('\t').map(p => p.trim()).filter(p => p);
        
        if (parts.length >= 3) {
            const width = parts[0];
            const blades = parseInt(parts[1]);
            const weight = parseFloat(parts[2]);
            
            const numWidth = parseFloat(width);
            if (!isNaN(numWidth) && !isNaN(blades) && !isNaN(weight) && width.toLowerCase() !== 'width') {
                widths[numWidth.toString()] = { blades, weight };
            }
        }
    });
    
    return widths;
}

// ========================================
// MANAGE JOBS
// ========================================

function displayJobCardList() {
    const listDiv = document.getElementById('jobCardList');
    if (!listDiv) return;

    const jobCards = getJobCardsList(true); // Use sorted list
    
    if (jobCards.length === 0) {
        listDiv.innerHTML = '<p style="text-align: center; color: #999;">No job cards yet</p>';
        return;
    }
    
    listDiv.innerHTML = jobCards.map(jobCard => {
        const data = jobCardData[jobCard];
        let badges = '';
        if (data.archived) badges += '<span class="archive-badge">ARCHIVED</span>';
        if (data.held) badges += '<span class="hold-badge">ON HOLD</span>';
        
        return `
            <div class="job-card-item">
                <div class="job-card-info">
                    <h4>${jobCard} - ${data.workOrder}${badges}</h4>
                    <p>Type: ${data.productionType} | Grade: ${data.grade} | Customer: ${data.customer || 'N/A'}</p>
                </div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="manage-btn" onclick="completeEntireJob('${jobCard}')" style="background: #28a745; color: white;">✓ Complete Job</button>
                    <button class="manage-btn hold-btn" onclick="toggleHold('${jobCard}')">${data.held ? '▶️ Resume' : '⏸️ Hold'}</button>
                    <button class="manage-btn delete-btn" onclick="deleteJobCard('${jobCard}')">🗑️ Delete</button>
                </div>
            </div>
        `;
    }).join('');
}



function toggleHold(jobCard) {
    jobCardData[jobCard].held = !jobCardData[jobCard].held;
    saveData('jobCardData', jobCardData);
    populateJobCardDropdowns();
    displayJobCardList();
}

function deleteJobCard(jobCard) {
    if (confirm(`Are you sure you want to PERMANENTLY DELETE job card ${jobCard}?\n\nThis will remove:\n- Job card data\n- All production entries\n- All completion records\n\nThis cannot be undone!`)) {
        // Delete from Firebase first (proper collection deletes)
        deleteJobCardFromFirebase(jobCard);
        
        // Delete each production entry from Firebase
        productionEntries
            .filter(e => e.jobCard === jobCard)
            .forEach(e => deleteProductionEntryFromFirebase(e.id));

        // Update local data
        delete jobCardData[jobCard];
        productionEntries = productionEntries.filter(e => e.jobCard !== jobCard);
        Object.keys(completedItems).forEach(key => {
            if (key.startsWith(jobCard + '-')) delete completedItems[key];
        });

        // Save updated local data
        localStorage.setItem('jobCardData', JSON.stringify(jobCardData));
        localStorage.setItem('productionEntries', JSON.stringify(productionEntries));
        localStorage.setItem('completedItems', JSON.stringify(completedItems));
        invalidateCache();

        populateJobCardDropdowns();
        displayJobCardList();
        displayCustomers();
        alert('Job card deleted successfully');
    }
}

// ========================================
// MONTHLY REPORT
// ========================================

function setCurrentMonth() {
    const now = new Date();
    document.getElementById('reportMonth').value = now.getMonth();
    document.getElementById('reportYear').value = now.getFullYear();
    updateMonthlyReport();
}

function updateMonthlyReport() {
    const monthEl = document.getElementById('reportMonth');
    const yearEl = document.getElementById('reportYear');
    
    // Guard: DOM not ready
    if (!monthEl || !yearEl) return;
    
    const month = parseInt(monthEl.value);
    const year = parseInt(yearEl.value);
    
    const startDate = new Date(year, month, 1);
    const endDate = new Date(year, month + 1, 0, 23, 59, 59);
    
    // JOB CARDS ADDED THIS MONTH (based on dateAdded field)
    const jobCardsAddedThisMonth = [];
    Object.keys(jobCardData).forEach(jobCard => {
        const data = jobCardData[jobCard];
        
        // Skip archived job cards
        if (data.archived) return;
        
        // Check if added this month using dateAdded
        if (data.dateAdded) {
            const addedDate = new Date(data.dateAdded);
            if (addedDate >= startDate && addedDate <= endDate) {
                jobCardsAddedThisMonth.push(jobCard);
            }
        }
    });
    
    // COMPLETED JOB CARDS (from those added this month)
    const completedJobCards = [];
    jobCardsAddedThisMonth.forEach(jobCard => {
        const data = jobCardData[jobCard];
        if (data) {
            let totalItems = 0;
            let completedCount = 0;
            
            [1, 2, 3].forEach(groupNum => {
                const group = data.groups[groupNum];
                if (group && group.widths) {
                    Object.keys(group.widths).forEach(width => {
                        if (data.productionType === 'Normal') {
                            totalItems += 3;
                            ['05mm', '00mm', '10mm'].forEach(mm => {
                                const key = `${jobCard}-${groupNum}-${width}-${mm}`;
                                if (completedItems[key]) completedCount++;
                            });
                        } else {
                            totalItems += 1;
                            const key = `${jobCard}-${groupNum}-${width}`;
                            if (completedItems[key]) completedCount++;
                        }
                    });
                }
            });
            
            if (completedCount === totalItems && totalItems > 0) {
                completedJobCards.push(jobCard);
            }
        }
    });
    
    // PRODUCTION ENTRIES THIS MONTH (for chart - show completion trend)
    const monthlyEntries = productionEntries.filter(e => {
        if (e.endTime) {
            // Show entries COMPLETED this month
            const completedDate = new Date(e.endTime);
            return completedDate >= startDate && completedDate <= endDate;
        }
        return false;
    });
    
    // UPDATE DISPLAY
    const jobCardsEl = document.getElementById('monthlyJobCards');
    const completedEl = document.getElementById('monthlyCompleted');
    const pendingEl = document.getElementById('monthlyPending');
    
    if (jobCardsEl) jobCardsEl.textContent = jobCardsAddedThisMonth.length;
    if (completedEl) completedEl.textContent = completedJobCards.length;
    if (pendingEl) pendingEl.textContent = jobCardsAddedThisMonth.length - completedJobCards.length;
    
    console.log('📊 Monthly Report Updated:', {
        month: month + 1,
        year: year,
        totalAdded: jobCardsAddedThisMonth.length,
        completed: completedJobCards.length,
        pending: jobCardsAddedThisMonth.length - completedJobCards.length,
        chartEntries: monthlyEntries.length
    });
    
    updateMonthlyChart(monthlyEntries);
    displayMonthlyJobList(jobCardsAddedThisMonth);
}

function updateMonthlyChart(entries) {
    const ctx = document.getElementById('monthlyChart');
    
    if (!ctx) {
        console.error('Chart canvas not found');
        return;
    }
    
    // Group entries by completion date
    const dailyData = {};
    entries.forEach(entry => {
        // Use endTime (completion date) for the trend
        const date = new Date(entry.endTime).toLocaleDateString();
        dailyData[date] = (dailyData[date] || 0) + 1;
    });
    
    const labels = Object.keys(dailyData).sort((a, b) => {
        return new Date(a) - new Date(b);
    });
    const data = labels.map(label => dailyData[label]);
    
    if (monthlyChart) {
        monthlyChart.destroy();
    }
    
    monthlyChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Completed Production',
                data: data,
                borderColor: '#2d7a3e',
                backgroundColor: 'rgba(45, 122, 62, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { 
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

function displayMonthlyJobList(jobCards) {
    const listDiv = document.getElementById('monthlyJobList');
    
    if (jobCards.length === 0) {
        listDiv.innerHTML = '<p style="text-align: center; color: #999;">No production data for selected month</p>';
        return;
    }
    
    listDiv.innerHTML = jobCards.map(jobCard => {
        const data = jobCardData[jobCard];
        if (!data) return '';
        
        let totalItems = 0;
        let completedCount = 0;
        
        [1, 2, 3].forEach(groupNum => {
            Object.keys(data.groups[groupNum].widths).forEach(width => {
                if (data.productionType === 'Normal') {
                    totalItems += 3;
                    ['05mm', '00mm', '10mm'].forEach(mm => {
                        const key = `${jobCard}-${groupNum}-${width}-${mm}`;
                        if (completedItems[key]) completedCount++;
                    });
                } else {
                    totalItems += 1;
                    const key = `${jobCard}-${groupNum}-${width}`;
                    if (completedItems[key]) completedCount++;
                }
            });
        });
        
        const percent = totalItems > 0 ? Math.round((completedCount / totalItems) * 100) : 0;
        
        return `
            <div class="job-card-item">
                <div class="job-card-info">
                    <h4>${jobCard} - ${data.workOrder}</h4>
                    <p>Type: ${data.productionType} | Grade: ${data.grade} | Progress: ${percent}%</p>
                </div>
                <div class="progress-bar-container" style="margin: 0;">
                    <div class="progress-bar" style="width: ${percent}%"><span>${percent}%</span></div>
                </div>
            </div>
        `;
    }).join('');
}

function exportMonthlyReport() {
    const data = [];
    let slNo = 1;
    
    const jobCards = Object.keys(jobCardData).sort();
    
    jobCards.forEach(jobCard => {
        const jobData = jobCardData[jobCard];
        let totalItems = 0;
        let completedCount = 0;
        
        [1, 2, 3].forEach(groupNum => {
            const group = jobData.groups[groupNum];
            if (group && group.widths) {
                Object.keys(group.widths).forEach(width => {
                    totalItems++;
                    
                    if (jobData.productionType === 'Normal') {
                        const allComplete = ['05mm', '00mm', '10mm'].every(mm => {
                            const key = `${jobCard}-${groupNum}-${width}-${mm}`;
                            return completedItems[key];
                        });
                        if (allComplete) completedCount++;
                    } else {
                        const key = `${jobCard}-${groupNum}-${width}`;
                        if (completedItems[key]) completedCount++;
                    }
                });
            }
        });
        
        const isCompleted = totalItems > 0 && completedCount === totalItems;
        const status = isCompleted ? 'Completed' : 'Pending';
        
        let completionDate = '-';
        if (isCompleted) {
            const completedEntries = productionEntries.filter(e => 
                e.jobCard === jobCard && e.status === 'completed' && e.endTime
            );
            
            if (completedEntries.length > 0) {
                const latestEntry = completedEntries.reduce((latest, entry) => {
                    const entryDate = new Date(entry.endTime);
                    const latestDate = new Date(latest.endTime);
                    return entryDate > latestDate ? entry : latest;
                });
                completionDate = new Date(latestEntry.endTime).toLocaleDateString();
            }
        }
        
        data.push({
            'SL No': slNo++,
            'Job Card': jobCard,
            'Customer': jobData.customer || '-',
            'Status': status,
            'Date Completed': completionDate
        });
    });
    
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Production Report');
    
    const fileName = 'Production_Report_' + new Date().toISOString().split('T')[0] + '.xlsx';
    XLSX.writeFile(wb, fileName);
    
    alert('Excel file exported successfully!');
}

// ========================================
// CUSTOMER MANAGEMENT
// ========================================

function displayCustomers() {
    const customersDiv = document.getElementById('customersList');
    
    const customerGroups = {};
    
    Object.keys(jobCardData).forEach(jobCard => {
        const data = jobCardData[jobCard];
        const customer = data.customer || 'No Customer';
        
        if (!customerGroups[customer]) {
            customerGroups[customer] = [];
        }
        customerGroups[customer].push({ jobCard, data });
    });
    
    if (Object.keys(customerGroups).length === 0) {
        customersDiv.innerHTML = '<p style="text-align: center; color: #999;">No customers yet</p>';
        return;
    }
    
    customersDiv.innerHTML = Object.keys(customerGroups).sort().map(customer => {
        const orders = customerGroups[customer];
        let totalOrders = orders.length;
        let completedOrders = 0;
        let totalBlades = 0;
        
        orders.forEach(order => {
            let totalItems = 0;
            let completedCount = 0;
            let orderBlades = 0;
            
            [1, 2, 3].forEach(groupNum => {
                Object.keys(order.data.groups[groupNum].widths).forEach(width => {
                    const widthData = order.data.groups[groupNum].widths[width];
                    orderBlades += widthData.blades;
                    
                    if (order.data.productionType === 'Normal') {
                        totalItems += 3;
                        ['05mm', '00mm', '10mm'].forEach(mm => {
                            const key = `${order.jobCard}-${groupNum}-${width}-${mm}`;
                            if (completedItems[key]) completedCount++;
                        });
                    } else {
                        totalItems += 1;
                        const key = `${order.jobCard}-${groupNum}-${width}`;
                        if (completedItems[key]) completedCount++;
                    }
                });
            });
            
            totalBlades += orderBlades;
            if (completedCount === totalItems && totalItems > 0) {
                completedOrders++;
            }
        });
        
        const customerId = customer.replace(/\s+/g, '-');
        
        return `
            <div class="customer-card" id="customer-${customerId}" onclick="toggleCustomerOrders('${customerId}')">
                <div class="customer-header">
                    <div class="customer-name">${customer}</div>
                    <div class="customer-icon">▼</div>
                </div>
                <div class="customer-stats">
                    <div class="customer-stat">
                        <div class="customer-stat-value">${totalOrders}</div>
                        <div class="customer-stat-label">Total Orders</div>
                    </div>
                    <div class="customer-stat">
                        <div class="customer-stat-value">${completedOrders}</div>
                        <div class="customer-stat-label">Completed</div>
                    </div>
                    <div class="customer-stat">
                        <div class="customer-stat-value">${totalOrders - completedOrders}</div>
                        <div class="customer-stat-label">Pending</div>
                    </div>
                </div>
                <div class="customer-orders" id="orders-${customerId}">
                    ${orders.map(order => {
                        let totalItems = 0;
                        let completedCount = 0;
                        
                        [1, 2, 3].forEach(groupNum => {
                            Object.keys(order.data.groups[groupNum].widths).forEach(width => {
                                if (order.data.productionType === 'Normal') {
                                    totalItems += 3;
                                    ['05mm', '00mm', '10mm'].forEach(mm => {
                                        const key = `${order.jobCard}-${groupNum}-${width}-${mm}`;
                                        if (completedItems[key]) completedCount++;
                                    });
                                } else {
                                    totalItems += 1;
                                    const key = `${order.jobCard}-${groupNum}-${width}`;
                                    if (completedItems[key]) completedCount++;
                                }
                            });
                        });
                        
                        const percent = totalItems > 0 ? Math.round((completedCount / totalItems) * 100) : 0;
                        const isComplete = percent === 100;
                        
                        return `
                            <div class="order-item">
                                <div class="order-header">
                                    <span class="order-number">📦 ${order.jobCard} - ${order.data.workOrder}</span>
                                    <span class="order-type">${order.data.productionType}</span>
                                </div>
                                <div class="order-progress">
                                    Grade: ${order.data.grade} | Thickness: ${order.data.thickness}
                                </div>
                                <div class="order-progress">
                                    Progress: ${completedCount}/${totalItems} items (${percent}%)
                                </div>
                                <div class="order-progress-bar">
                                    <div class="order-progress-fill ${isComplete ? 'complete' : ''}" style="width: ${percent}%"></div>
                                </div>
                                <button class="order-details-btn" onclick="showOrderDetails('${order.jobCard}'); event.stopPropagation();">View Details</button>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }).join('');
}

function toggleCustomerOrders(customerId) {
    const ordersDiv = document.getElementById(`orders-${customerId}`);
    const card = document.getElementById(`customer-${customerId}`);
    
    if (ordersDiv.classList.contains('show')) {
        ordersDiv.classList.remove('show');
        card.classList.remove('expanded');
    } else {
        ordersDiv.classList.add('show');
        card.classList.add('expanded');
    }
}

function showOrderDetails(jobCard) {
    const data = jobCardData[jobCard];
    if (!data) return;
    
    let totalItems = 0;
    let completedCount = 0;
    let totalBlades = 0;
    let completedBlades = 0;
    
    
    
    const groupDetails = [1, 2, 3].map(groupNum => {
        const group = data.groups[groupNum];
        const widths = Object.keys(group.widths).sort((a, b) => b - a);
        
        let groupTotal = 0;
        let groupCompleted = 0;
        
        const widthRows = widths.map(width => {
            const widthData = group.widths[width];
            totalBlades += widthData.blades;
            
            groupTotal++;
            
            let isComplete = false;
            
            if (data.productionType === 'Normal') {
                totalItems += 3;
                const allMM = ['05mm', '00mm', '10mm'].every(mm => {
                    const key = `${jobCard}-${groupNum}-${width}-${mm}`;
                    return completedItems[key];
                });
                if (allMM) {
                    isComplete = true;
                    completedCount += 3;
                    completedBlades += widthData.blades;
                    
                    groupCompleted++;
                }
            } else {
                totalItems++;
                const key = `${jobCard}-${groupNum}-${width}`;
                if (completedItems[key]) {
                    isComplete = true;
                    completedCount++;
                    completedBlades += widthData.blades;
                    
                    groupCompleted++;
                }
            }
            
            return `
                <div class="modal-width-item">
                    <span class="modal-width-name">Width ${width}mm</span>
                    <span class="modal-width-status ${isComplete ? 'complete' : 'pending'}">
                        ${isComplete ? '✓ Complete' : '⏳ Pending'}
                    </span>
                </div>
            `;
        }).join('');
        
        const groupPercent = groupTotal > 0 ? Math.round((groupCompleted / groupTotal) * 100) : 0;
        
        return `
            <div class="modal-section">
                <div class="modal-section-title">🔹 ${group.section} (${groupPercent}%)</div>
                ${widthRows}
            </div>
        `;
    }).join('');
    
    const overallPercent = totalItems > 0 ? Math.round((completedCount / totalItems) * 100) : 0;
    
    const modalContent = `
        <h2 class="modal-title">Order Details</h2>
        
        <div class="modal-info-grid">
            <div class="modal-info-item">
                <div class="modal-info-label">Job Card</div>
                <div class="modal-info-value">${jobCard}</div>
            </div>
            <div class="modal-info-item">
                <div class="modal-info-label">Work Order</div>
                <div class="modal-info-value">${data.workOrder}</div>
            </div>
            <div class="modal-info-item">
                <div class="modal-info-label">Customer</div>
                <div class="modal-info-value">${data.customer || 'N/A'}</div>
            </div>
            <div class="modal-info-item">
                <div class="modal-info-label">Production Type</div>
                <div class="modal-info-value">${data.productionType}</div>
            </div>
            <div class="modal-info-item">
                <div class="modal-info-label">Grade</div>
                <div class="modal-info-value">${data.grade}</div>
            </div>
            <div class="modal-info-item">
                <div class="modal-info-label">Thickness</div>
                <div class="modal-info-value">${data.thickness}</div>
            </div>
            <div class="modal-info-item">
                <div class="modal-info-label">Rating</div>
                <div class="modal-info-value">${data.rating}</div>
            </div>
            <div class="modal-info-item">
                <div class="modal-info-label">Status</div>
                <div class="modal-info-value">${data.archived ? 'Archived' : data.held ? 'On Hold' : 'Active'}</div>
            </div>
        </div>
        
        <div class="modal-divider"></div>
        
        <h3 style="color: #2d7a3e; margin-bottom: 15px;">Production Breakdown</h3>
        
        ${groupDetails}
        
        <div class="modal-overall">
            <div class="modal-overall-title">Overall Progress</div>
            <div class="progress-bar-container" style="margin: 10px 0;">
                <div class="progress-bar" style="width: ${overallPercent}%">
                    <span>${overallPercent}%</span>
                </div>
            </div>
            <div class="modal-overall-stats">
                <div class="modal-overall-stat">
                    <div class="modal-overall-value">${completedCount}/${totalItems}</div>
                    <div class="modal-overall-label">Items Completed</div>
                </div>
                <div class="modal-overall-stat">
                    <div class="modal-overall-value">${Math.round(completedBlades)}/${totalBlades}</div>
                    <div class="modal-overall-label">Blades</div>
                </div>
                <div class="modal-overall-stat">
                    <div class="modal-overall-value">${Math.round(completedWeight)}/${totalWeight}</div>
                    <div class="modal-overall-label">Weight (kg)</div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('orderModalContent').innerHTML = modalContent;
    document.getElementById('orderModal').classList.add('show');
}

function closeOrderModal() {
    document.getElementById('orderModal').classList.remove('show');
}

// ========================================
// INITIALIZE ON PAGE LOAD
// ========================================

window.addEventListener('DOMContentLoaded', function() {
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
        currentUser = JSON.parse(savedUser);
        showApp();
    }
});

    

// ========================================
// CENTRE MM CONDITIONAL DISPLAY  
// ========================================
// Show Centre MM only for Normal production types (not Step Lap)

function updateCentreMMVisibility() {
    var productionTypeFilter = document.getElementById('productionTypeFilter');
    var centreMMSection = document.getElementById('centreMMSection');
    
    if (productionTypeFilter && centreMMSection) {
        var prodType = productionTypeFilter.value;
        // Show only if Normal or Normal-0mm
        if (prodType === 'Normal' || prodType === 'Normal-0mm') {
            centreMMSection.style.display = 'block';
        } else {
            centreMMSection.style.display = 'none';
        }
    }
}

// ========================================
// EDIT JOB CARD
// ========================================

function editJobCard(jobCard) {
    if (!jobCardData || !jobCardData[jobCard]) {
        alert('Job card not found: ' + jobCard);
        return;
    }
    
    var data = jobCardData[jobCard];
    
    var modal = document.createElement('div');
    modal.className = 'edit-modal show';
    modal.id = 'editModal';
    
    var content = '<div class="edit-modal-content">';
    content += '<span onclick="closeEditModal()" style="position:absolute;right:20px;top:15px;font-size:28px;cursor:pointer;color:#999;">&times;</span>';
    content += '<h2 style="color:#2d7a3e;margin-bottom:20px;">Edit Job Card</h2>';
    
    content += '<div class="form-group"><label>Job Card Number</label>';
    content += '<input type="text" value="' + jobCard + '" disabled style="background:#f0f0f0;"></div>';
    
    content += '<div class="form-group"><label>Work Order *</label>';
    content += '<input type="text" id="editWorkOrder" value="' + data.workOrder + '"></div>';
    
    content += '<div class="form-group"><label>Production Type *</label>';
    content += '<select id="editProductionType">';
    content += '<option value="Normal"' + (data.productionType === 'Normal' ? ' selected' : '') + '>Normal</option>';
    content += '<option value="Normal-0mm"' + (data.productionType === 'Normal-0mm' ? ' selected' : '') + '>Normal-0mm</option>';
    content += '<option value="Step Lap"' + (data.productionType === 'Step Lap' ? ' selected' : '') + '>Step Lap</option>';
    content += '</select></div>';
    
    content += '<div class="form-group"><label>Grade *</label>';
    content += '<select id="editGrade">';
    content += '<option value="M4"' + (data.grade === 'M4' ? ' selected' : '') + '>M4</option>';
    content += '<option value="MOH"' + (data.grade === 'MOH' ? ' selected' : '') + '>MOH</option>';
    content += '<option value="M3"' + (data.grade === 'M3' ? ' selected' : '') + '>M3</option>';
    content += '<option value="ZDKH"' + (data.grade === 'ZDKH' ? ' selected' : '') + '>ZDKH</option>';
    content += '<option value="M5"' + (data.grade === 'M5' ? ' selected' : '') + '>M5</option>';
    content += '</select></div>';
    
    content += '<div class="form-group"><label>Thickness *</label>';
    content += '<input type="text" id="editThickness" value="' + data.thickness + '"></div>';
    
    content += '<div class="form-group"><label>Rating</label>';
    content += '<input type="text" id="editRating" value="' + (data.rating || '') + '"></div>';
    
    content += '<div class="form-group"><label>Customer Name</label>';
    content += '<input type="text" id="editCustomer" value="' + (data.customer || '') + '"></div>';
    
    content += '<button class="submit-btn" onclick="saveEditedJobCard(\'' + jobCard + '\')">Save Changes</button>';
    content += '<button class="submit-btn" style="background:#6c757d;margin-top:10px;" onclick="closeEditModal()">Cancel</button>';
    content += '</div>';
    
    modal.innerHTML = content;
    document.body.appendChild(modal);
}

function closeEditModal() {
    var modal = document.getElementById('editModal');
    if (modal) {
        modal.remove();
    }
}

function saveEditedJobCard(jobCard) {
    var workOrder = document.getElementById('editWorkOrder').value.trim();
    var productionType = document.getElementById('editProductionType').value;
    var grade = document.getElementById('editGrade').value;
    var thickness = document.getElementById('editThickness').value.trim();
    var rating = document.getElementById('editRating').value.trim();
    var customer = document.getElementById('editCustomer').value.trim();
    
    if (!workOrder || !productionType || !grade || !thickness) {
        alert('Please fill all required fields');
        return;
    }
    
    jobCardData[jobCard].workOrder = workOrder;
    jobCardData[jobCard].productionType = productionType;
    jobCardData[jobCard].grade = grade;
    jobCardData[jobCard].thickness = thickness;
    jobCardData[jobCard].rating = rating;
    jobCardData[jobCard].customer = customer;
    
    saveData('jobCardData', jobCardData);
    
    closeEditModal();
    
    populateJobCardDropdowns();
    displayJobCardList();
    if (typeof displayCustomers === 'function') {
        displayCustomers();
    }
    
    alert('Job card updated!');
}

// ========================================
// EXPORT DATA
// ========================================

function exportData() {
    var data = {
        jobCards: localStorage.getItem('jobCardData'),
        entries: localStorage.getItem('productionEntries'),
        completed: localStorage.getItem('completedItems'),
        exportDate: new Date().toISOString()
    };
    
    var blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'evergreen-backup-' + new Date().toISOString().split('T')[0] + '.json';
    a.click();
    URL.revokeObjectURL(url);
    
    alert('Data exported!');
}

// ========================================
// IMPORT DATA
// ========================================

function importData(input) {
    var file = input.files[0];
    if (!file) return;
    
    if (!confirm('This will replace all data. Continue?')) {
        input.value = '';
        return;
    }
    
    var reader = new FileReader();
    reader.onload = function(e) {
        try {
            var data = JSON.parse(e.target.result);
            if (data.jobCards) localStorage.setItem('jobCardData', data.jobCards);
            if (data.entries) localStorage.setItem('productionEntries', data.entries);
            if (data.completed) localStorage.setItem('completedItems', data.completed);
            alert('Data imported! Reloading...');
            location.reload();
        } catch (error) {
            alert('Error: ' + error.message);
        }
    };
    reader.readAsText(file);
    input.value = '';
}




// Update Firebase status indicator
function updateFirebaseStatus() {
    const statusEl = document.getElementById('firebaseStatus');
    const dotEl = statusEl ? statusEl.querySelector('.status-dot') : null;
    const textEl = document.getElementById('statusText');
    
    if (!statusEl || !dotEl || !textEl) return;
    
    if (firebaseActive) {
        statusEl.className = 'firebase-status active';
        dotEl.className = 'status-dot active';
        textEl.textContent = 'Cloud Sync';
    } else {
        statusEl.className = 'firebase-status inactive';
        dotEl.className = 'status-dot inactive';
        textEl.textContent = 'Local';
    }
}

// Call this after Firebase init
setTimeout(updateFirebaseStatus, 1000);



// Complete a started production item
function completeStartedItem(entryId) {
    const entry = productionEntries.find(e => e.id === entryId);
    if (!entry) { alert('Item not found!'); return; }

    const operatorName = prompt('Enter operator name for completion:', entry.operator);
    if (!operatorName) return;

    const remarks = prompt('Enter completion remarks (optional):');

    // Update entry
    entry.status = 'completed';
    entry.endTime = new Date().toISOString();
    entry.endOperator = operatorName;
    if (remarks) entry.endRemarks = remarks;

    // Mark width as completed
    const { jobCard, width, itemType, diamondMM } = entry;
    if (itemType === 'yoke-side') {
        for (let g = 1; g <= 2; g++) {
            const k = diamondMM ? `${jobCard}-${g}-${width}-${diamondMM}` : `${jobCard}-${g}-${width}`;
            completedItems[k] = true;
        }
    } else if (itemType === 'centre') {
        const k = diamondMM ? `${jobCard}-3-${width}-${diamondMM}` : `${jobCard}-3-${width}`;
        completedItems[k] = true;
    }

    // Save both to localStorage AND Firebase (efficient - one doc each)
    saveProductionEntry(entry);  // Writes just this entry to productions/{id}
    saveData('completedItems', completedItems); // Writes per-job completedItems docs

    alert(`✓ ${width}mm ${itemType} completed successfully!`);
    displayProductionList();
    if (typeof updateDashboard === 'function') updateDashboard();
}

// Hold/Unhold functions
function holdJobCard(jobCard) {
    if (!confirm('Are you sure you want to hold ' + jobCard + '?')) return;
    if (jobCardData[jobCard]) {
        jobCardData[jobCard].held = true;
        saveData('jobCardData', jobCardData); // Syncs to Firebase
        alert('Job card ' + jobCard + ' has been put on hold');
        if (typeof displayJobCards === 'function') displayJobCards();
        populateJobCardDropdowns();
    }
}

function unholdJobCard(jobCard) {
    if (jobCardData[jobCard]) {
        jobCardData[jobCard].held = false;
        saveData('jobCardData', jobCardData); // Syncs to Firebase
        alert('Job card ' + jobCard + ' has been resumed');
        if (typeof displayJobCards === 'function') displayJobCards();
        populateJobCardDropdowns();
    }
}




// Complete entire job - mark all widths as done
function completeEntireJob(jobCard) {
    if (!jobCardData[jobCard]) {
        alert('Job card not found!');
        return;
    }
    
    const data = jobCardData[jobCard];
    const confirmMsg = `Are you sure you want to mark ALL production for ${jobCard} as completed?\n\nThis will mark ALL widths in ALL groups as done.`;
    
    if (!confirm(confirmMsg)) {
        return;
    }
    
    let itemsCompleted = 0;
    
    // Mark all widths in all groups as completed
    [1, 2, 3].forEach(groupNum => {
        const group = data.groups[groupNum];
        if (group && group.widths) {
            Object.keys(group.widths).forEach(width => {
                if (data.productionType === 'Normal') {
                    // Normal type: complete all three diamond sizes
                    ['05mm', '00mm', '10mm'].forEach(mm => {
                        const key = `${jobCard}-${groupNum}-${width}-${mm}`;
                        if (!completedItems[key]) {
                            completedItems[key] = true;
                            itemsCompleted++;
                        }
                    });
                } else {
                    // Taper Lap or Step Lap: complete the width
                    const key = `${jobCard}-${groupNum}-${width}`;
                    if (!completedItems[key]) {
                        completedItems[key] = true;
                        itemsCompleted++;
                    }
                }
            });
        }
    });
    
    // Save to BOTH localStorage AND Firebase (proper sync)
    saveData('completedItems', completedItems);

    alert(`✓ Job ${jobCard} marked as complete!\n${itemsCompleted} items completed.`);
    
    // Refresh displays
    if (typeof displayJobCards === 'function') displayJobCards();
    if (typeof updateDashboard === 'function') updateDashboard();
}




// ============================================================================
// DATA CLEANUP & MAINTENANCE
// ============================================================================

// Clean old completed production entries (keep last 6 months)
function cleanupOldEntries() {
    const sixMonthsAgo = Date.now() - (180 * 24 * 60 * 60 * 1000);
    const before = productionEntries.length;
    
    productionEntries = productionEntries.filter(entry => {
        // Keep if started in last 6 months OR not completed yet
        const entryTime = new Date(entry.startTime).getTime();
        return entryTime > sixMonthsAgo || !entry.endTime;
    });
    
    const removed = before - productionEntries.length;
    if (removed > 0) {
        saveData('productionEntries', productionEntries); // Syncs to Firebase too
        console.log(`🧹 Cleaned up ${removed} old entries`);
    }
    
    return removed;
}

// Run cleanup on startup (after 5 seconds)
setTimeout(function() {
    cleanupOldEntries();
}, 5000);

// Auto-cleanup every 24 hours
setInterval(function() {
    cleanupOldEntries();
}, 24 * 60 * 60 * 1000);




// ============================================================================
// PERFORMANCE MONITORING
// ============================================================================

// Monitor performance and show warnings
function checkPerformance() {
    const jobCount = Object.keys(jobCardData).length;
    const entryCount = productionEntries.length;
    const storageSize = JSON.stringify(localStorage).length;
    
    console.log('📊 Performance Stats:');
    console.log('  Job Cards:', jobCount);
    console.log('  Production Entries:', entryCount);
    console.log('  Storage Size:', (storageSize / 1024).toFixed(2), 'KB');
    
    // Warn if getting large
    if (jobCount > 150) {
        console.warn('⚠️ High job card count. Consider archiving old jobs.');
    }
    if (entryCount > 5000) {
        console.warn('⚠️ High entry count. Running cleanup...');
        cleanupOldEntries();
    }
    if (storageSize > 4 * 1024 * 1024) { // 4MB
        console.warn('⚠️ Storage getting full. Consider cleanup.');
    }
}

// Run performance check on startup
setTimeout(checkPerformance, 3000);

// Run every hour
setInterval(checkPerformance, 60 * 60 * 1000);




// Show/hide loading overlay
function showLoading() {
    document.getElementById('loadingOverlay').classList.add('show');
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.remove('show');
}


</script>

    <!-- Firebase Status Indicator -->
    <div id="firebaseStatus" class="firebase-status inactive">
        <span class="status-dot inactive"></span>
        <span id="statusText">Local</span>
    </div>


    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Processing...</p>
        </div>
    </div>
    
</body>
</html>